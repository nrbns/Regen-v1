version: "3.9"

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: redix
      POSTGRES_USER: redix
      POSTGRES_PASSWORD: redix
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    command: ["postgres", "-c", "log_statement=all"]

  qdrant:
    image: qdrant/qdrant:v1.11
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__LOG_LEVEL=info

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  api:
    build: ./server
    depends_on:
      - postgres
      - qdrant
      - redis
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://redix:redix@postgres:5432/redix
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET=dev-super-secret-change-in-prod
      - EMBED_MODEL=bge-small-en-v1.5-int8.onnx
      - SYNC_ENABLED=false
      - ASYNC_EMBED=true
      - EMBED_STREAM=memory:queue
    volumes:
      - ./server:/app

  embed-worker:
    build: ./server
    command: python -m workers.embed
    depends_on:
      - api
    environment:
      - REDIS_URL=redis://redis:6379/0
      - EMBED_STREAM=memory:queue
      - EMBED_GROUP=embed-workers
      - DATABASE_URL=postgresql://redix:redix@postgres:5432/redix

  decay-worker:
    build: ./server
    command: python -m workers.decay
    depends_on:
      - api
    environment:
      - DATABASE_URL=postgresql://redix:redix@postgres:5432/redix

volumes:
  pgdata:
  qdrant_storage:

