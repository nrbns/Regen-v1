import{r as d,j as n,bZ as de,o as ue,Q as me,S as K,b_ as V,a0 as ye}from"./vendor-react-gmX1Lmvt.js";import{a as B,i as h,b as he,c as fe}from"./core-ai-yFIunLTZ.js";import{i as _}from"../assets/index-D9cF9G1U.js";import{m as U}from"./vendor-framer-motion-DDE19Uim.js";import"./vendor-react-dom-Bkb6jJ_S.js";import"./vendor-Vl2WtvH-.js";import"./vendor-zustand-BWsgwsXr.js";import"./mode-manager.ts-DwguZmJt.js";import"./core-memory-DmK-uh9X.js";import"./mode-research-BclgCwOH.js";import"./vendor-utils-5Vdoy44w.js";import"./mode-docs-FcsoolLb.js";import"./vendor-pdf-ejcqEZLU.js";import"./vendor-mammoth-BPQIafDs.js";import"@tauri-apps/api/core";const E=new Map,T=new Map,F=new Set;let oe=!1;function j(){F.forEach(r=>{try{r()}catch(t){console.error("[CommandRegistry] Listener error",t)}})}function ae(r){return E.has(r.id)&&console.warn(`[CommandRegistry] Command with id "${r.id}" already registered. Overwriting.`),E.set(r.id,r),j(),()=>{E.delete(r.id)&&j()}}function pe(r){return T.has(r.id)&&console.warn(`[CommandRegistry] Command source with id "${r.id}" already registered. Overwriting.`),T.set(r.id,r),j(),()=>{T.delete(r.id)&&j()}}async function ge(){const r=Array.from(E.values()),t=await Promise.all(Array.from(T.values()).map(async i=>{try{return await i.getCommands()}catch(l){return console.error(`[CommandRegistry] Failed to load commands from source "${i.id}":`,l),[]}}));return[...r,...t.flat()]}function be(r){return F.add(r),()=>{F.delete(r)}}function we(){oe=!0}function xe(){return oe}function ve(){j()}let W=!1;const Ce=[{id:"core:new-tab",title:"Open New Tab",subtitle:"Create a blank tab in the current container",category:"Navigation",keywords:["tab","new","create"],shortcut:["Ctrl/Cmd","T"],run:async()=>{await h.tabs.create("about:blank")}},{id:"core:privacy-dashboard",title:"Open Privacy Dashboard",subtitle:"Review shields, permissions, and session data",category:"Privacy",keywords:["privacy","dashboard","settings"],run:()=>{window.location.hash="#/privacy"}},{id:"core:save-workspace",title:"Save Workspace Snapshot",subtitle:"Capture current tabs and layout into a workspace bundle",category:"Workspace",keywords:["workspace","session","save"],run:async()=>{const r=prompt("Name of the workspace snapshot?");r&&await h.storage.saveWorkspace({id:crypto.randomUUID(),name:r,partition:`persist:workspace:${Date.now()}`})}},{id:"core:burn-active-tab",title:"Burn Active Tab",subtitle:"Permanently delete data for the current tab",category:"Privacy",keywords:["burn","tab","privacy"],run:async()=>{const{activeId:r}=B.getState();!r||!confirm("Burn this tab? All associated storage will be destroyed.")||await h.tabs.burn(r)}},{id:"core:ask-agent",title:"Ask Omni Agent",subtitle:"Send a custom question to the AI agent",category:"AI",keywords:["agent","ai","question"],run:async()=>{const r=prompt("What would you like the agent to do?");r&&await h.agent.createTask({title:"Command Palette Request",role:"researcher",goal:r,budget:{tokens:4096,seconds:120,requests:20}})}}];function ke(){[{id:"core:mode-browse",title:"Switch to Browse Mode",mode:"Browse"},{id:"core:mode-research",title:"Switch to Research Mode",mode:"Research"},{id:"core:mode-threats",title:"Switch to Threat Mode",mode:"Threats"},{id:"core:mode-trade",title:"Switch to Trade Mode",mode:"Trade"},{id:"core:mode-docs",title:"Switch to Docs Mode",mode:"Docs"}].forEach(t=>{ae({id:t.id,title:t.title,category:"Modes",keywords:["mode",t.mode.toLowerCase()],run:()=>{he.getState().setMode(t.mode)}})})}function Se(){Ce.forEach(r=>ae(r))}function je(){pe({id:"dynamic:tabs",getCommands:async()=>{const{tabs:r,activeId:t}=B.getState();return r.slice(0,25).map(i=>({id:`tab:focus:${i.id}`,title:i.title||"Untitled Tab",subtitle:i.url,category:"Tabs",badge:i.id===t?"Active":void 0,keywords:[i.title,i.url].filter(Boolean),run:async()=>{await h.tabs.activate({id:i.id})}}))}}),B.subscribe(()=>{ve()})}function Ie(){W||(W=!0,Se(),ke(),je(),we())}function Z(){return W&&xe()}var Ae=Object.defineProperty,Ne=(r,t,i)=>t in r?Ae(r,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[t]=i,$e=(r,t,i)=>Ne(r,t+"",i);const ee="command-history",te=50;class Re{constructor(){$e(this,"history",[]),this.load()}load(){try{const t=localStorage.getItem(ee);t&&(this.history=JSON.parse(t))}catch(t){console.warn("[CommandHistory] Failed to load history:",t),this.history=[]}}save(){try{localStorage.setItem(ee,JSON.stringify(this.history))}catch(t){console.warn("[CommandHistory] Failed to save history:",t)}}record(t,i){this.history=this.history.filter(l=>l.commandId!==t),this.history.unshift({commandId:t,timestamp:Date.now(),query:i}),this.history.length>te&&(this.history=this.history.slice(0,te)),this.save()}getRecent(t=10){return this.history.slice(0,t)}getUsageCount(t){return this.history.filter(i=>i.commandId===t).length}getMostUsed(t=10){const i=new Map;for(const l of this.history)i.set(l.commandId,(i.get(l.commandId)||0)+1);return Array.from(i.entries()).map(([l,u])=>({commandId:l,count:u})).sort((l,u)=>u.count-l.count).slice(0,t)}clear(){this.history=[],this.save()}}const R=new Re,Ee="https://duckduckgo.com/?q=",re={action:0,command:1,container:2,tab:3,history:4},Te=/^(https?:\/\/|chrome:\/\/|edge:\/\/|about:|file:\/\/)/i,Me=/^[\w.-]+\.[a-z]{2,}(?:[\/?#].*)?$/i,se=(r,t="33")=>{if(!(!r||!r.startsWith("#"))){if(r.length===4){const i=r[1],l=r[2],u=r[3];return`#${i}${i}${l}${l}${u}${u}${t}`}return r.length===7?`${r}${t}`:r}},De=r=>r?r.charAt(0).toUpperCase()+r.slice(1):"",Oe=r=>{const t=r.trim();if(!t)return{url:"about:blank",description:"Open a blank tab",isDirect:!0};if(Te.test(t))return{url:t,description:t,isDirect:!0};if(!/\s/.test(t)&&Me.test(t)){const i=t.startsWith("www.")?`https://${t}`:`https://${t}`;return{url:i,description:i,isDirect:!0}}return{url:`${Ee}${encodeURIComponent(t)}`,description:`Search the web for “${t}”`,isDirect:!1}};function Pe(r,t){if(!t)return 0;const i=r.toLowerCase().trim(),l=t.toLowerCase();if(l===i)return 1e3;if(l.startsWith(i))return 500;const u=l.split(/\s+/),g=i.split(/\s+/);let w=0;for(const f of g)for(const M of u)if(M.startsWith(f)){w+=100;break}if(w>0)return w;let b=0,v=0,C=-1,k=0;for(let f=0;f<l.length&&v<i.length;f++)l[f]===i[v]&&(b+=5,C===f-1?(k++,b+=3*k):k=1,f===0&&(b+=10),C=f,v++);v===i.length&&(b+=10);const I=(l.length-v)/l.length;return b=Math.max(0,b-I*5),b}function ze(r,t,i=0){const l=[t.title,t.subtitle,t.category,t.badge,...t.keywords??[]];let u=0;for(const g of l){const w=Pe(r,g);w>u&&(u=w)}return i>0&&(u+=Math.min(i*2,20)),u}function tt({onClose:r}){const[t,i]=d.useState(""),[l,u]=d.useState(0),[g,w]=d.useState([]),[b,v]=d.useState(!Z()),[C,k]=d.useState([]),[I,f]=d.useState([]),[M,D]=d.useState(!1),[q,G]=d.useState([]),[A,ne]=d.useState(!1),{containers:x,activeContainerId:Y,setContainers:O,setActiveContainer:N}=fe(s=>({containers:s.containers,activeContainerId:s.activeContainerId,setContainers:s.setContainers,setActiveContainer:s.setActiveContainer})),Q=d.useRef(x),ie=d.useRef(null);d.useEffect(()=>{Q.current=x},[x]),d.useEffect(()=>{Z()||Ie();let s=!0;const o=async()=>{const a=await ge();s&&(w(a),v(!1),u(0))};o();const c=be(()=>{o()});return()=>{s=!1,c()}},[]),d.useEffect(()=>{let s=!0;return(async()=>{try{const c=await h.history.list();s&&k(Array.isArray(c)?c.slice(0,20):[])}catch(c){console.warn("[CommandPalette] Failed to load history list:",c)}})(),()=>{s=!1}},[]),d.useEffect(()=>{let s=!1;x.length===0&&h.containers.list().then(a=>{!s&&Array.isArray(a)&&O(a)}).catch(a=>{console.warn("[CommandPalette] Failed to load containers:",a)});const o=_.on("containers:list",a=>{Array.isArray(a)&&O(a)}),c=_.on("containers:active",a=>{if(!a)return;const m=a.container??Q.current.find(S=>S.id===a.containerId);m&&N(m)});return()=>{s=!0,o(),c()}},[x.length,O,N]),d.useEffect(()=>{let s=!1;(async()=>{try{const a=await h.tabs.list();!s&&Array.isArray(a)&&G(a)}catch(a){console.warn("[CommandPalette] Failed to load tabs:",a)}})();const c=_.on("tabs:updated",a=>{Array.isArray(a)&&G(a)});return()=>{s=!0,c()}},[]),d.useEffect(()=>{const s=t.trim();if(s.length<2){f([]),D(!1);return}let o=!1;return D(!0),(async()=>{try{const a=await h.history.search(s);o||f(Array.isArray(a)?a.slice(0,20):[])}catch(a){o||(console.warn("[CommandPalette] History search failed:",a),f([]))}finally{o||D(!1)}})(),()=>{o=!0}},[t]);const P=d.useMemo(()=>{const s=t.trim(),o=s.toLowerCase(),c=o.length>=2?I:C,a=new Map;for(const e of g)a.set(e.id,R.getUsageCount(e.id));const m=g.map(e=>({id:e.id,title:e.title,subtitle:e.subtitle,category:e.category,type:"command",keywords:e.keywords,shortcut:e.shortcut,badge:e.badge,run:async()=>{R.record(e.id,s),await e.run()},meta:{usageCount:a.get(e.id)||0}})),S=x.map(e=>({id:`container:${e.id}`,title:`Switch to ${e.name}`,subtitle:e.description||`${De(e.scope??"session")} container`,category:"Containers",type:"container",badge:e.id===Y?"Active":void 0,keywords:[e.name,e.description??"",e.id,e.scope??""],meta:{color:e.color,container:e},run:async()=>{try{const $=await h.containers.setActive(e.id)||e;N($)}catch(p){console.warn("[CommandPalette] Failed to switch container:",p)}}})),H=q.map(e=>({id:`tab:${e.id}`,title:e.title||e.url||"Untitled tab",subtitle:e.url,category:"Open Tabs",type:"tab",badge:e.active?"Current Tab":e.containerName,keywords:[e.title??"",e.url??"",e.containerName??"",e.mode??""],meta:{color:e.containerColor,active:e.active},run:async()=>{await h.tabs.activate({id:e.id})}})),L=c.map(e=>({id:`history:${e.id}`,title:e.title||e.url,subtitle:e.url,category:"History",type:"history",badge:e.visitCount?`${e.visitCount}×`:void 0,keywords:[e.url,e.title],run:async()=>{e.url&&await h.tabs.create({url:e.url})}})),X=[...s.length>0?x.map(e=>{const p=Oe(s);return{id:`open:${e.id}:${s}`,title:p.isDirect?`Open ${p.url} in ${e.name}`:`Search “${s}” in ${e.name}`,subtitle:p.description,category:"Open in Container",type:"action",badge:"New Tab",keywords:[s,e.name,e.id],meta:{color:e.color},run:async()=>{await h.tabs.create({url:p.url,containerId:e.id})}}}):[],...m,...S,...H,...L];return o?X.map(e=>({item:e,score:ze(o,e,e.meta?.usageCount||0)})).filter(({score:e})=>e>0).sort((e,p)=>{if(p.score!==e.score)return p.score-e.score;const $=re[e.item.type]??99,J=re[p.item.type]??99;return $!==J?$-J:e.item.title.localeCompare(p.item.title)}).slice(0,30).map(({item:e})=>e):X.slice(0,30)},[t,g,x,Y,q,I,C,N]),z=d.useMemo(()=>{if(!A)return[];const s=R.getRecent(10),o=[];for(const c of s){const a=g.find(m=>m.id===c.commandId);if(a&&(o.push({id:`recent:${c.commandId}`,title:a.title,subtitle:a.subtitle||`Used ${new Date(c.timestamp).toLocaleDateString()}`,category:"Recent Commands",type:"command",keywords:a.keywords,shortcut:a.shortcut,badge:"Recent",run:async()=>{R.record(a.id),await a.run()},icon:n.jsx(de,{size:14})}),o.length>=5))break}return o},[A,g]),y=d.useMemo(()=>A&&z.length>0&&t.trim().length===0?[...z,...P.slice(0,25)]:P,[A,z,P,t]),ce=d.useMemo(()=>{const s=[];let o="";return y.forEach((c,a)=>{c&&c.category!==o?(o=c.category,s.push({category:o,items:[c],startIndex:a})):c&&s[s.length-1]?.items.push(c)}),s},[y]);d.useEffect(()=>{const s=o=>{o.key==="Escape"?r():o.key==="ArrowDown"?(o.preventDefault(),u(c=>Math.min(c+1,Math.max(y.length-1,0)))):o.key==="ArrowUp"?(o.preventDefault(),u(c=>Math.max(c-1,0))):o.key==="Enter"&&(o.preventDefault(),y[l]&&(y[l].run(),r()))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[l,y,r]),d.useEffect(()=>{l>=y.length&&u(y.length>0?y.length-1:0)},[y,l]),d.useEffect(()=>{ne(t.trim().length===0)},[t]);const le=s=>{const o=typeof s.meta?.color=="string"?s.meta.color:void 0,c="inline-flex h-6 w-6 items-center justify-center rounded-lg border text-[11px]",a=o!=null?c:`${c} border-gray-700 bg-gray-800/60 text-gray-300`,m=o!=null?{borderColor:se(o,"66")??o,backgroundColor:se(o,"22")??o,color:o}:void 0;if(s.icon)return n.jsx("span",{className:a,style:m,children:s.icon});switch(s.type){case"history":return n.jsx("span",{className:a,style:m,children:n.jsx(ye,{size:14})});case"container":return n.jsx("span",{className:a,style:m,children:n.jsx(V,{size:14})});case"tab":return n.jsx("span",{className:a,style:m,children:n.jsx(V,{size:12})});case"action":return n.jsx("span",{className:a,style:m,children:n.jsx(K,{size:14})});default:return n.jsx("span",{className:a,style:m,children:n.jsx(K,{size:14})})}};return n.jsxs(U.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-start justify-center pt-[15vh]",onClick:r,children:[n.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm"}),n.jsxs(U.div,{initial:{scale:.95,opacity:0,y:-20},animate:{scale:1,opacity:1,y:0},exit:{scale:.95,opacity:0,y:-20},onClick:s=>s.stopPropagation(),className:"relative w-full max-w-2xl mx-4 bg-gray-900/95 backdrop-blur-xl border border-gray-800/50 rounded-2xl shadow-2xl overflow-hidden",children:[n.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 border-b border-gray-800/50",children:[n.jsx(ue,{size:20,className:"text-gray-400"}),n.jsx("input",{ref:ie,type:"text",value:t,onChange:s=>{i(s.target.value),u(0)},autoFocus:!0,placeholder:"Type a command or search...",className:"flex-1 bg-transparent text-gray-200 placeholder-gray-500 focus:outline-none"}),n.jsx("kbd",{className:"px-2 py-1 bg-gray-800 border border-gray-700 rounded text-xs text-gray-400",children:"Esc"})]}),n.jsx("div",{className:"max-h-96 overflow-y-auto",children:y.length>0?n.jsx("div",{className:"py-2",children:ce.map(s=>n.jsxs("div",{children:[n.jsx("div",{className:"px-4 pt-3 pb-1 text-[11px] uppercase tracking-wider text-gray-500",children:s.category}),n.jsx("div",{className:"flex flex-col",children:s.items.map((o,c)=>{const a=s.startIndex+c,m=l===a,S=le(o);return n.jsxs(U.button,{onClick:async()=>{await o.run(),r()},onMouseEnter:()=>u(a),className:`w-full flex items-center justify-between px-4 py-3 text-left transition-colors ${m?"bg-blue-600/20 border-l-2 border-blue-500":"hover:bg-gray-800/40 border-l-2 border-transparent"}`,children:[n.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[S,n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"text-sm font-medium text-gray-200 truncate",children:o.title}),o.badge&&n.jsx("span",{className:"rounded-full border border-gray-700 bg-gray-800/60 px-2 py-0.5 text-[10px] uppercase tracking-wide text-gray-400",children:o.badge})]}),o.subtitle&&n.jsx("div",{className:"text-xs text-gray-500 truncate",children:o.subtitle})]})]}),n.jsxs("div",{className:"flex items-center gap-2 ml-4 shrink-0",children:[o.shortcut&&n.jsx("span",{className:"flex items-center gap-1 text-[11px] text-gray-500",children:o.shortcut.map((H,L)=>n.jsx("kbd",{className:"rounded border border-gray-700 bg-gray-800/60 px-1.5 py-0.5 text-[10px] text-gray-400",children:H},`${o.id}-sc-${L}`))}),n.jsx(me,{size:16,className:"text-gray-500"})]})]},o.id)})})]},`section-${s.category}`))}):n.jsx("div",{className:"py-8 text-center text-gray-500 text-sm",children:b||M?"Searching…":"No commands found"})}),n.jsxs("div",{className:"px-4 py-2 border-t border-gray-800/50 flex items-center justify-between text-xs text-gray-500",children:[n.jsxs("div",{className:"flex items-center gap-4",children:[n.jsx("span",{children:"↑↓ Navigate"}),n.jsx("span",{children:"↵ Select"}),n.jsx("span",{children:"Esc Close"})]}),n.jsxs("span",{children:[y.length," ",y.length===1?"result":"results"]})]})]})]})}export{tt as CommandPalette};
//# sourceMappingURL=CommandPalette-C3fUrmXD.js.map
