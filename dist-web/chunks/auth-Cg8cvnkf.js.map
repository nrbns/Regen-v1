{"version":3,"file":"auth-Cg8cvnkf.js","sources":["../../src/services/auth.ts"],"sourcesContent":["/**\n * Authentication Service - Tier 3 Pillar 3\n * Magic link and device code authentication\n */\n\nimport { log } from '../utils/logger';\nimport { track } from './analytics';\n\nexport type AuthMethod = 'magic_link' | 'device_code' | 'anonymous';\n\nexport type User = {\n  id: string;\n  email?: string;\n  displayName?: string;\n  createdAt: number;\n  lastSeenAt: number;\n};\n\nexport type AuthState = {\n  user: User | null;\n  isAuthenticated: boolean;\n  method: AuthMethod | null;\n};\n\nclass AuthService {\n  private currentUser: User | null = null;\n  private authMethod: AuthMethod | null = null;\n\n  /**\n   * Initialize auth state from storage\n   */\n  async initialize(): Promise<AuthState> {\n    try {\n      const stored = localStorage.getItem('regen_auth');\n      if (stored) {\n        const data = JSON.parse(stored);\n        this.currentUser = data.user;\n        this.authMethod = data.method;\n        log.info('[Auth] Restored session for user:', this.currentUser?.id);\n        track('auth_session_restored', { userId: this.currentUser?.id });\n      }\n    } catch (error) {\n      log.error('[Auth] Failed to restore session:', error);\n    }\n\n    return this.getState();\n  }\n\n  /**\n   * Request magic link\n   */\n  async requestMagicLink(email: string): Promise<{ success: boolean; message: string }> {\n    try {\n      // TODO: Call backend API\n      // For now, simulate success\n      log.info('[Auth] Magic link requested for:', email);\n      track('auth_magic_link_requested', { email });\n\n      // Simulate async operation\n      await new Promise(resolve => setTimeout(resolve, 1000));\n\n      return {\n        success: true,\n        message: 'Check your email for the magic link',\n      };\n    } catch (error) {\n      log.error('[Auth] Magic link request failed:', error);\n      return {\n        success: false,\n        message: 'Failed to send magic link. Please try again.',\n      };\n    }\n  }\n\n  /**\n   * Request device code\n   */\n  async requestDeviceCode(): Promise<{ code: string; expiresAt: number } | null> {\n    try {\n      // TODO: Call backend API\n      log.info('[Auth] Device code requested');\n      track('auth_device_code_requested');\n\n      // Generate a simple code for demo\n      const code = Math.random().toString(36).slice(2, 10).toUpperCase();\n      const expiresAt = Date.now() + 10 * 60 * 1000; // 10 minutes\n\n      return { code, expiresAt };\n    } catch (error) {\n      log.error('[Auth] Device code request failed:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Verify magic link token\n   */\n  async verifyMagicLink(_token: string): Promise<AuthState> {\n    try {\n      // TODO: Call backend API to verify token\n      // For now, create anonymous user\n      const user: User = {\n        id: `user-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`,\n        createdAt: Date.now(),\n        lastSeenAt: Date.now(),\n      };\n\n      this.currentUser = user;\n      this.authMethod = 'magic_link';\n      this.persistState();\n\n      log.info('[Auth] Magic link verified, user:', user.id);\n      track('auth_magic_link_verified', { userId: user.id });\n\n      return this.getState();\n    } catch (error) {\n      log.error('[Auth] Magic link verification failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Verify device code\n   */\n  async verifyDeviceCode(_code: string): Promise<AuthState> {\n    try {\n      // TODO: Call backend API to verify code\n      // For now, create anonymous user\n      const user: User = {\n        id: `user-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`,\n        createdAt: Date.now(),\n        lastSeenAt: Date.now(),\n      };\n\n      this.currentUser = user;\n      this.authMethod = 'device_code';\n      this.persistState();\n\n      log.info('[Auth] Device code verified, user:', user.id);\n      track('auth_device_code_verified', { userId: user.id });\n\n      return this.getState();\n    } catch (error) {\n      log.error('[Auth] Device code verification failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Create anonymous session\n   */\n  async createAnonymousSession(): Promise<AuthState> {\n    const user: User = {\n      id: `anon-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`,\n      createdAt: Date.now(),\n      lastSeenAt: Date.now(),\n    };\n\n    this.currentUser = user;\n    this.authMethod = 'anonymous';\n    this.persistState();\n\n    log.info('[Auth] Anonymous session created:', user.id);\n    track('auth_anonymous_session_created', { userId: user.id });\n\n    return this.getState();\n  }\n\n  /**\n   * Sign out\n   */\n  async signOut(): Promise<void> {\n    const userId = this.currentUser?.id;\n    this.currentUser = null;\n    this.authMethod = null;\n    localStorage.removeItem('regen_auth');\n\n    log.info('[Auth] User signed out:', userId);\n    track('auth_signed_out', { userId });\n  }\n\n  /**\n   * Get current auth state\n   */\n  getState(): AuthState {\n    return {\n      user: this.currentUser,\n      isAuthenticated: !!this.currentUser,\n      method: this.authMethod,\n    };\n  }\n\n  /**\n   * Get current user\n   */\n  getCurrentUser(): User | null {\n    return this.currentUser;\n  }\n\n  /**\n   * Persist auth state\n   */\n  private persistState(): void {\n    localStorage.setItem(\n      'regen_auth',\n      JSON.stringify({\n        user: this.currentUser,\n        method: this.authMethod,\n      })\n    );\n  }\n\n  /**\n   * Update last seen\n   */\n  updateLastSeen(): void {\n    if (this.currentUser) {\n      this.currentUser.lastSeenAt = Date.now();\n      this.persistState();\n    }\n  }\n}\n\n// Singleton instance\nexport const authService = new AuthService();\n"],"names":["AuthService","__publicField","stored","data","log","track","error","email","resolve","code","expiresAt","_token","user","_code","userId","authService"],"mappings":"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"}