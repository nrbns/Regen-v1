{"version":3,"file":"sync-C-mJ7UTb.js","sources":["../../src/services/sync.ts"],"sourcesContent":["/**\n * Sync Service - Tier 3 Pillar 3\n * Sync workspaces, settings, bookmarks across devices\n */\n\nimport { authService } from './auth';\nimport { useWorkspacesStore } from '../state/workspacesStore';\nimport { useBookmarksStore } from '../state/bookmarksStore';\nimport { useSettingsStore } from '../state/settingsStore';\nimport { log } from '../utils/logger';\nimport { track } from './analytics';\n\nexport type SyncData = {\n  workspaces: unknown[];\n  bookmarks: unknown[];\n  settings: unknown;\n  version: number;\n  syncedAt: number;\n};\n\nexport type SyncConflict = {\n  type: 'workspace' | 'bookmark' | 'setting';\n  local: unknown;\n  remote: unknown;\n  key: string;\n};\n\nclass SyncService {\n  private syncEnabled = false;\n  private lastSyncAt: number | null = null;\n  private syncInProgress = false;\n\n  /**\n   * Enable sync\n   */\n  async enable(): Promise<boolean> {\n    const authState = authService.getState();\n    if (!authState.isAuthenticated) {\n      log.warn('[Sync] Cannot enable sync without authentication');\n      return false;\n    }\n\n    this.syncEnabled = true;\n    localStorage.setItem('regen_sync_enabled', 'true');\n    log.info('[Sync] Sync enabled');\n    track('sync_enabled');\n\n    // Perform initial sync\n    await this.sync();\n\n    return true;\n  }\n\n  /**\n   * Disable sync\n   */\n  disable(): void {\n    this.syncEnabled = false;\n    localStorage.removeItem('regen_sync_enabled');\n    log.info('[Sync] Sync disabled');\n    track('sync_disabled');\n  }\n\n  /**\n   * Check if sync is enabled\n   */\n  isEnabled(): boolean {\n    if (typeof window === 'undefined') return false;\n    const stored = localStorage.getItem('regen_sync_enabled');\n    return stored === 'true' && authService.getState().isAuthenticated;\n  }\n\n  /**\n   * Pull data from server\n   */\n  async pull(): Promise<SyncData | null> {\n    const authState = authService.getState();\n    if (!authState.isAuthenticated || !authState.user) {\n      return null;\n    }\n\n    try {\n      // TODO: Call backend API\n      // GET /api/sync/pull?userId={userId}\n      log.info('[Sync] Pulling data from server');\n\n      // For now, return null (no remote data)\n      return null;\n    } catch (error) {\n      log.error('[Sync] Pull failed:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Push data to server\n   */\n  async push(): Promise<boolean> {\n    const authState = authService.getState();\n    if (!authState.isAuthenticated || !authState.user) {\n      return false;\n    }\n\n    try {\n      const data: SyncData = {\n        workspaces: useWorkspacesStore.getState().workspaces,\n        bookmarks: useBookmarksStore.getState().bookmarks,\n        settings: useSettingsStore.getState(),\n        version: 1,\n        syncedAt: Date.now(),\n      };\n\n      // TODO: Call backend API\n      // POST /api/sync/push\n      log.info('[Sync] Pushing data to server');\n\n      this.lastSyncAt = Date.now();\n      track('sync_pushed', { itemCount: data.workspaces.length + data.bookmarks.length });\n\n      return true;\n    } catch (error) {\n      log.error('[Sync] Push failed:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Sync (pull + merge + push)\n   */\n  async sync(): Promise<{ success: boolean; conflicts?: SyncConflict[] }> {\n    if (this.syncInProgress) {\n      log.warn('[Sync] Sync already in progress');\n      return { success: false };\n    }\n\n    if (!this.isEnabled()) {\n      log.warn('[Sync] Sync not enabled');\n      return { success: false };\n    }\n\n    this.syncInProgress = true;\n\n    try {\n      // Pull remote data\n      const remoteData = await this.pull();\n\n      if (remoteData) {\n        // Merge with local data\n        const conflicts = await this.merge(remoteData);\n\n        if (conflicts.length > 0) {\n          log.warn('[Sync] Conflicts detected:', conflicts.length);\n          track('sync_conflicts', { count: conflicts.length });\n          return { success: true, conflicts };\n        }\n      }\n\n      // Push local changes\n      await this.push();\n\n      this.lastSyncAt = Date.now();\n      track('sync_completed');\n\n      return { success: true };\n    } catch (error) {\n      log.error('[Sync] Sync failed:', error);\n      track('sync_failed', { error: String(error) });\n      return { success: false };\n    } finally {\n      this.syncInProgress = false;\n    }\n  }\n\n  /**\n   * Merge remote data with local (last-write-wins for v1)\n   */\n  private async merge(remoteData: SyncData): Promise<SyncConflict[]> {\n    const conflicts: SyncConflict[] = [];\n\n    // Merge workspaces (last-write-wins)\n    const _localWorkspaces = useWorkspacesStore.getState().workspaces;\n    const remoteWorkspaces = remoteData.workspaces as typeof _localWorkspaces;\n\n    // Simple merge: remote wins if newer\n    if (remoteData.syncedAt > (this.lastSyncAt || 0)) {\n      useWorkspacesStore.setState({ workspaces: remoteWorkspaces });\n    }\n\n    // Merge bookmarks (last-write-wins)\n    const _localBookmarks = useBookmarksStore.getState().bookmarks;\n    const remoteBookmarks = remoteData.bookmarks as typeof _localBookmarks;\n\n    if (remoteData.syncedAt > (this.lastSyncAt || 0)) {\n      useBookmarksStore.setState({ bookmarks: remoteBookmarks });\n    }\n\n    // Merge settings (last-write-wins)\n    const _localSettings = useSettingsStore.getState();\n    const remoteSettings = remoteData.settings as typeof _localSettings;\n\n    if (remoteData.syncedAt > (this.lastSyncAt || 0)) {\n      useSettingsStore.setState(remoteSettings);\n    }\n\n    return conflicts;\n  }\n\n  /**\n   * Get last sync time\n   */\n  getLastSyncAt(): number | null {\n    return this.lastSyncAt;\n  }\n\n  /**\n   * Auto-sync on interval\n   */\n  startAutoSync(intervalMs = 5 * 60 * 1000): void {\n    // Sync every 5 minutes if enabled\n    setInterval(() => {\n      if (this.isEnabled() && !this.syncInProgress) {\n        this.sync().catch(error => {\n          log.error('[Sync] Auto-sync failed:', error);\n        });\n      }\n    }, intervalMs);\n  }\n}\n\n// Singleton instance\nexport const syncService = new SyncService();\n"],"names":["SyncService","__publicField","authService","log","track","authState","error","data","useWorkspacesStore","useBookmarksStore","useSettingsStore","remoteData","conflicts","remoteWorkspaces","remoteBookmarks","remoteSettings","intervalMs","syncService"],"mappings":"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"}