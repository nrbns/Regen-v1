{"version":3,"mappings":"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","names":["captureScreenshot","element","ipc","__vitePreload","n","useTabsStore","tabsState","activeTab","result","captureViewportScreenshot","toast","html2canvas","error","analyzeScreenshot","screenshotDataUrl","query","base64Image","imageUrl","prompt","apiBase","response","data","pageText","extractVisibleText","analysisPrompt","aiEngine","walker","node","parent","style","texts","text","captureAndAnalyze","screenshot"],"ignoreList":[],"sources":["../../src/core/wispr/screenshotAnalyzer.ts"],"sourcesContent":["/**\r\n * WISPR Screenshot Analyzer\r\n * Captures screenshots and analyzes them with GPT-4 Vision\r\n */\r\n\r\nimport { aiEngine } from '../ai/engine';\r\nimport { toast } from '../../utils/toast';\r\n\r\n/**\r\n * Capture screenshot of current page or selected element\r\n */\r\nexport async function captureScreenshot(element?: HTMLElement): Promise<string | null> {\r\n  try {\r\n    // Try using IPC screenshot API if available (Electron/Tauri)\r\n    if (typeof window !== 'undefined') {\r\n      const { ipc } = await import('../../lib/ipc-typed');\r\n\r\n      // Try to capture active tab screenshot\r\n      try {\r\n        const { useTabsStore } = await import('../../state/tabsStore');\r\n        const tabsState = useTabsStore.getState();\r\n        const activeTab = tabsState.tabs.find(t => t.id === tabsState.activeId);\r\n\r\n        if (activeTab) {\r\n          // Use capturePreview which returns dataUrl directly\r\n          const result = await ipc.tabs.capturePreview({ id: activeTab.id });\r\n          if (result?.success && result?.dataUrl) {\r\n            return result.dataUrl;\r\n          }\r\n        }\r\n      } catch {\r\n        console.debug('[WISPR] IPC screenshot not available, trying fallback');\r\n      }\r\n    }\r\n\r\n    // Fallback: Use html2canvas if available, or canvas API\r\n    if (element) {\r\n      return await captureElementScreenshot(element);\r\n    }\r\n\r\n    // Capture visible viewport\r\n    return await captureViewportScreenshot();\r\n  } catch {\r\n    console.error('[WISPR] Screenshot capture failed');\r\n    toast.error('Failed to capture screenshot');\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Capture screenshot of a specific element\r\n */\r\nasync function captureElementScreenshot(element: HTMLElement): Promise<string | null> {\r\n  try {\r\n    // Use html2canvas if available\r\n    const html2canvas = (window as any).html2canvas;\r\n    if (html2canvas && typeof html2canvas === 'function') {\r\n      const canvas = await html2canvas(element, {\r\n        backgroundColor: '#000000',\r\n        scale: 2, // Higher scale for better quality\r\n        useCORS: true,\r\n        logging: false,\r\n        allowTaint: true,\r\n        // CRITICAL: Enhance contrast for dark charts\r\n        onclone: (clonedDoc: Document) => {\r\n          // Increase brightness/contrast for dark elements\r\n          const clonedElement = clonedDoc.querySelector(element.tagName.toLowerCase());\r\n          if (clonedElement) {\r\n            (clonedElement as HTMLElement).style.filter = 'brightness(1.2) contrast(1.1)';\r\n          }\r\n        },\r\n      });\r\n      \r\n      // CRITICAL: Post-process for dark charts - enhance visibility\r\n      const ctx = canvas.getContext('2d');\r\n      if (ctx) {\r\n        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n        const data = imageData.data;\r\n        \r\n        // Enhance dark areas (increase brightness for very dark pixels)\r\n        for (let i = 0; i < data.length; i += 4) {\r\n          const r = data[i];\r\n          const g = data[i + 1];\r\n          const b = data[i + 2];\r\n          const brightness = (r + g + b) / 3;\r\n          \r\n          // If pixel is very dark, brighten it slightly\r\n          if (brightness < 30) {\r\n            data[i] = Math.min(255, r + 20);     // Red\r\n            data[i + 1] = Math.min(255, g + 20); // Green\r\n            data[i + 2] = Math.min(255, b + 20); // Blue\r\n          }\r\n        }\r\n        \r\n        ctx.putImageData(imageData, 0, 0);\r\n      }\r\n      \r\n      // Convert to JPEG with quality for better compression and compatibility\r\n      return canvas.toDataURL('image/jpeg', 0.95);\r\n    }\r\n\r\n    // Fallback: Use canvas API\r\n    const canvas = document.createElement('canvas');\r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return null;\r\n\r\n    const rect = element.getBoundingClientRect();\r\n    canvas.width = rect.width;\r\n    canvas.height = rect.height;\r\n\r\n    // This is a simplified version - html2canvas is better\r\n    ctx.fillStyle = '#ffffff';\r\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n    ctx.fillStyle = '#000000';\r\n    ctx.font = '16px Arial';\r\n    ctx.fillText('Screenshot capture requires html2canvas', 10, 30);\r\n\r\n    return canvas.toDataURL('image/png');\r\n  } catch (error) {\r\n    console.error('[WISPR] Element screenshot failed:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Capture screenshot of visible viewport\r\n */\r\nasync function captureViewportScreenshot(): Promise<string | null> {\r\n  try {\r\n    // Use html2canvas if available\r\n    const html2canvas = (window as any).html2canvas;\r\n    if (html2canvas && typeof html2canvas === 'function') {\r\n      const canvas = await html2canvas(document.body, {\r\n        backgroundColor: '#000000',\r\n        scale: 1,\r\n        useCORS: true,\r\n        windowWidth: window.innerWidth,\r\n        windowHeight: window.innerHeight,\r\n      });\r\n      return canvas.toDataURL('image/png');\r\n    }\r\n\r\n    // Fallback: Try to get active tab screenshot via IPC\r\n    try {\r\n      const { ipc } = await import('../../lib/ipc-typed');\r\n      const { useTabsStore } = await import('../../state/tabsStore');\r\n      const tabsState = useTabsStore.getState();\r\n      const activeTab = tabsState.tabs.find(t => t.id === tabsState.activeId);\r\n\r\n      if (activeTab) {\r\n        // Use capturePreview which returns dataUrl directly\r\n        const result = await ipc.tabs.capturePreview({ id: activeTab.id });\r\n        if (result?.success && result?.dataUrl) {\r\n          return result.dataUrl;\r\n        }\r\n      }\r\n    } catch {\r\n      console.debug('[WISPR] IPC screenshot fallback failed');\r\n    }\r\n\r\n    return null;\r\n  } catch (error) {\r\n    console.error('[WISPR] Viewport screenshot failed:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Analyze screenshot with GPT-4 Vision\r\n */\r\nexport async function analyzeScreenshot(\r\n  screenshotDataUrl: string,\r\n  query?: string\r\n): Promise<string | null> {\r\n  try {\r\n    toast.info('Analyzing screenshot with AI...');\r\n\r\n    // CRITICAL: Convert data URL to base64 and ensure proper format for GPT-4o Vision\r\n    let base64Image = screenshotDataUrl.split(',')[1] || screenshotDataUrl;\r\n    \r\n    // If it's a data URL, extract base64\r\n    if (screenshotDataUrl.startsWith('data:image/')) {\r\n      base64Image = screenshotDataUrl.split(',')[1];\r\n    }\r\n    \r\n    // Ensure image is in correct format (JPEG or PNG base64)\r\n    // GPT-4o Vision accepts: data:image/jpeg;base64,<data> or data:image/png;base64,<data>\r\n    const imageFormat = screenshotDataUrl.includes('image/jpeg') ? 'jpeg' : 'png';\r\n    const imageUrl = `data:image/${imageFormat};base64,${base64Image}`;\r\n\r\n    // Use AI engine with vision capability\r\n    // Note: This requires backend support for GPT-4 Vision API\r\n    const prompt = query\r\n      ? `Analyze this screenshot and answer: ${query}. Pay special attention to charts, graphs, and dark backgrounds. Describe what you see in detail, including any numbers, trends, or patterns visible.`\r\n      : 'Analyze this screenshot. Describe what you see, identify any charts, graphs, text, or important information. Pay attention to dark backgrounds and ensure all visible elements are described.';\r\n\r\n    // Try backend API first (if it supports vision)\r\n    const apiBase =\r\n      import.meta.env.VITE_APP_API_URL ||\r\n      import.meta.env.VITE_API_BASE_URL ||\r\n      (typeof window !== 'undefined' ? (window as any).__OB_API_BASE__ : '');\r\n\r\n    if (apiBase) {\r\n      try {\r\n        const response = await fetch(`${apiBase.replace(/\\/$/, '')}/api/ai/vision`, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify({\r\n            image: imageUrl, // Send full data URL format for GPT-4o Vision\r\n            prompt,\r\n            model: 'gpt-4o', // Explicitly use GPT-4o for vision\r\n            max_tokens: 1000,\r\n          }),\r\n        });\r\n\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          return data.analysis || data.text || null;\r\n        }\r\n      } catch {\r\n        console.warn('[WISPR] Vision API not available, falling back to text description');\r\n      }\r\n    }\r\n\r\n    // Fallback: Use regular AI with text description\r\n    // Extract any visible text from the page\r\n    const pageText = extractVisibleText();\r\n    const analysisPrompt = query\r\n      ? `${prompt}\\n\\nContext from page: ${pageText.substring(0, 1000)}`\r\n      : `Describe what's on this page. Context: ${pageText.substring(0, 1000)}`;\r\n\r\n    const result = await aiEngine.runTask({\r\n      kind: 'chat',\r\n      prompt: analysisPrompt,\r\n      context: {\r\n        hasScreenshot: true,\r\n        pageText: pageText.substring(0, 2000),\r\n      },\r\n    });\r\n\r\n    return result.text;\r\n  } catch (error) {\r\n    console.error('[WISPR] Screenshot analysis failed:', error);\r\n    toast.error('Failed to analyze screenshot');\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Extract visible text from current page\r\n */\r\nfunction extractVisibleText(): string {\r\n  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {\r\n    acceptNode: node => {\r\n      const parent = node.parentElement;\r\n      if (!parent) return NodeFilter.FILTER_REJECT;\r\n\r\n      // Skip hidden elements\r\n      const style = window.getComputedStyle(parent);\r\n      if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') {\r\n        return NodeFilter.FILTER_REJECT;\r\n      }\r\n\r\n      // Skip script and style tags\r\n      if (parent.tagName === 'SCRIPT' || parent.tagName === 'STYLE') {\r\n        return NodeFilter.FILTER_REJECT;\r\n      }\r\n\r\n      return NodeFilter.FILTER_ACCEPT;\r\n    },\r\n  });\r\n\r\n  const texts: string[] = [];\r\n  let node;\r\n  while ((node = walker.nextNode())) {\r\n    const text = node.textContent?.trim();\r\n    if (text && text.length > 0) {\r\n      texts.push(text);\r\n    }\r\n  }\r\n\r\n  return texts.join(' ').substring(0, 5000); // Limit to 5000 chars\r\n}\r\n\r\n/**\r\n * Full screenshot capture and analysis workflow\r\n */\r\nexport async function captureAndAnalyze(query?: string): Promise<string | null> {\r\n  const screenshot = await captureScreenshot();\r\n  if (!screenshot) {\r\n    toast.error('Failed to capture screenshot');\r\n    return null;\r\n  }\r\n\r\n  const analysis = await analyzeScreenshot(screenshot, query);\r\n  return analysis;\r\n}\r\n"],"file":"screenshotAnalyzer--BZfFR7x.js"}