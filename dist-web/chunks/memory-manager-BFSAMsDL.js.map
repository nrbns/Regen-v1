{"version":3,"file":"memory-manager-BFSAMsDL.js","sources":["../../src/core/redix/memory-manager.ts"],"sourcesContent":["// @ts-nocheck\n\nimport { ipc } from '../../lib/ipc-typed';\nimport { useMemoryStore, type MemorySnapshot, type TabMemorySample } from '../../state/memoryStore';\nimport { dispatch } from './runtime';\n\nlet initialized = false;\nlet pollTimer: ReturnType<typeof setInterval> | null = null;\n\nexport function initMemoryManager(): void {\n  if (initialized) return;\n  initialized = true;\n  captureSnapshot().catch(() => {});\n  pollTimer = setInterval(() => captureSnapshot().catch(() => {}), 20_000);\n  window.addEventListener(\n    'beforeunload',\n    () => {\n      if (pollTimer) clearInterval(pollTimer);\n    },\n    { once: true }\n  );\n}\n\nasync function captureSnapshot(): Promise<void> {\n  if (!ipc?.tabs?.getAllMetrics || !ipc?.tabs?.list) return;\n  try {\n    const [metrics, tabs] = await Promise.all([ipc.tabs.getAllMetrics(), ipc.tabs.list()]);\n    const now = Date.now();\n\n    const tabSamples: TabMemorySample[] = tabs.map(tab => {\n      const metric = metrics?.[tab.id];\n      return {\n        tabId: tab.id,\n        title: tab.title,\n        url: tab.url,\n        memoryMB: metric?.memoryMB ?? 0,\n        timestamp: now,\n        pinned: tab.pinned,\n        appMode: tab.appMode,\n        sleeping: tab.sleeping,\n      };\n    });\n\n    const totalPerTabs = tabSamples.reduce((sum, sample) => sum + sample.memoryMB, 0);\n    const capacity =\n      typeof navigator !== 'undefined' && 'deviceMemory' in navigator\n        ? (navigator.deviceMemory as number) * 1024\n        : undefined;\n\n    const snapshot: MemorySnapshot = {\n      totalMB: totalPerTabs,\n      timestamp: now,\n      tabs: tabSamples,\n      savingsMB: estimateSavings(tabSamples),\n      freeMB: capacity ? Math.max(0, capacity - totalPerTabs) : undefined,\n    };\n\n    useMemoryStore.getState().pushSnapshot(snapshot);\n    if (capacity) {\n      useMemoryStore.getState().setCapacity(capacity);\n    }\n    dispatch({\n      type: 'redix:memory:snapshot',\n      payload: {\n        totalMB: snapshot.totalMB,\n        timestamp: now,\n      },\n    });\n  } catch (error) {\n    console.warn('[MemoryManager] Failed to capture snapshot', error);\n  }\n}\n\nfunction estimateSavings(samples: TabMemorySample[]): number | undefined {\n  if (!samples.length) return undefined;\n  const sleeping = samples.filter(sample => sample.sleeping);\n  if (!sleeping.length) return 0;\n  const active = samples.filter(sample => !sample.sleeping);\n  const baseline =\n    active.length > 0\n      ? active.reduce((sum, sample) => sum + sample.memoryMB, 0) / active.length\n      : samples.reduce((sum, sample) => sum + sample.memoryMB, 0) / samples.length;\n  const saved = sleeping.reduce((sum, sample) => sum + Math.max(0, baseline - sample.memoryMB), 0);\n  return Math.max(0, saved);\n}\n"],"names":["initialized","pollTimer","initMemoryManager","captureSnapshot","ipc","metrics","tabs","now","tabSamples","tab","metric","totalPerTabs","sum","sample","capacity","snapshot","estimateSavings","useMemoryStore","dispatch","error","samples","sleeping","active","baseline","saved"],"mappings":"m6BAMA,IAAIA,EAAc,GACdC,EAAmD,KAEhD,SAASC,GAA0B,CACpCF,IACJA,EAAc,GACdG,EAAA,EAAkB,MAAM,IAAM,CAAC,CAAC,EAChCF,EAAY,YAAY,IAAME,EAAA,EAAkB,MAAM,IAAM,CAAC,CAAC,EAAG,GAAM,EACvE,OAAO,iBACL,eACA,IAAM,CACAF,iBAAyBA,CAAS,CACxC,EACA,CAAE,KAAM,EAAA,CAAK,EAEjB,CAEA,eAAeE,GAAiC,CAC9C,GAAI,GAACC,GAAK,MAAM,eAAiB,CAACA,GAAK,MAAM,MAC7C,GAAI,CACF,KAAM,CAACC,EAASC,CAAI,EAAI,MAAM,QAAQ,IAAI,CAACF,EAAI,KAAK,gBAAiBA,EAAI,KAAK,KAAA,CAAM,CAAC,EAC/EG,EAAM,KAAK,IAAA,EAEXC,EAAgCF,EAAK,IAAIG,GAAO,CACpD,MAAMC,EAASL,IAAUI,EAAI,EAAE,EAC/B,MAAO,CACL,MAAOA,EAAI,GACX,MAAOA,EAAI,MACX,IAAKA,EAAI,IACT,SAAUC,GAAQ,UAAY,EAC9B,UAAWH,EACX,OAAQE,EAAI,OACZ,QAASA,EAAI,QACb,SAAUA,EAAI,QAAA,CAElB,CAAC,EAEKE,EAAeH,EAAW,OAAO,CAACI,EAAKC,IAAWD,EAAMC,EAAO,SAAU,CAAC,EAC1EC,EACJ,OAAO,UAAc,KAAe,iBAAkB,UACjD,UAAU,aAA0B,KACrC,OAEAC,EAA2B,CAC/B,QAASJ,EACT,UAAWJ,EACX,KAAMC,EACN,UAAWQ,EAAgBR,CAAU,EACrC,OAAQM,EAAW,KAAK,IAAI,EAAGA,EAAWH,CAAY,EAAI,MAAA,EAG5DM,EAAe,SAAA,EAAW,aAAaF,CAAQ,EAC3CD,GACFG,EAAe,SAAA,EAAW,YAAYH,CAAQ,EAEhDI,EAAS,CACP,KAAM,wBACN,QAAS,CACP,QAASH,EAAS,QAClB,UAAWR,CAAA,CACb,CACD,CACH,OAASY,EAAO,CACd,QAAQ,KAAK,6CAA8CA,CAAK,CAClE,CACF,CAEA,SAASH,EAAgBI,EAAgD,CACvE,GAAI,CAACA,EAAQ,OAAQ,OACrB,MAAMC,EAAWD,EAAQ,OAAOP,GAAUA,EAAO,QAAQ,EACzD,GAAI,CAACQ,EAAS,OAAQ,MAAO,GAC7B,MAAMC,EAASF,EAAQ,OAAOP,GAAU,CAACA,EAAO,QAAQ,EAClDU,EACJD,EAAO,OAAS,EACZA,EAAO,OAAO,CAACV,EAAKC,IAAWD,EAAMC,EAAO,SAAU,CAAC,EAAIS,EAAO,OAClEF,EAAQ,OAAO,CAACR,EAAKC,IAAWD,EAAMC,EAAO,SAAU,CAAC,EAAIO,EAAQ,OACpEI,EAAQH,EAAS,OAAO,CAACT,EAAKC,IAAWD,EAAM,KAAK,IAAI,EAAGW,EAAWV,EAAO,QAAQ,EAAG,CAAC,EAC/F,OAAO,KAAK,IAAI,EAAGW,CAAK,CAC1B"}