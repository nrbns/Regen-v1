{"version":3,"file":"registry-CG5fPtjR.js","sources":["../../src/core/plugins/registry.ts"],"sourcesContent":["/**\n * Plugin Registry - Tier 3 Pillar 4\n * User-level extensions and plugin management\n */\n\nimport { log } from '../../utils/logger';\nimport { track } from '../../services/analytics';\nimport { toolRegistryV2 } from '../agent/tools/v2';\n\nexport type PanelDefinition = {\n  id: string;\n  name: string;\n  component: React.ComponentType;\n  mode?: string; // Which mode this panel appears in\n  position?: 'left' | 'right' | 'bottom';\n};\n\nexport type OmniPlugin = {\n  id: string;\n  name: string;\n  version: string;\n  description?: string;\n  author?: string;\n  enabled: boolean;\n  registerTools?: (registry: typeof toolRegistryV2) => void;\n  registerPanels?: () => PanelDefinition[];\n  onEnable?: () => void | Promise<void>;\n  onDisable?: () => void | Promise<void>;\n};\n\nclass PluginRegistry {\n  private plugins: Map<string, OmniPlugin> = new Map();\n  private panels: Map<string, PanelDefinition> = new Map();\n\n  /**\n   * Register a plugin\n   */\n  register(plugin: OmniPlugin): void {\n    if (this.plugins.has(plugin.id)) {\n      log.warn(`[PluginRegistry] Plugin ${plugin.id} already registered, skipping`);\n      return;\n    }\n\n    this.plugins.set(plugin.id, plugin);\n\n    // Register tools if provided\n    if (plugin.registerTools && plugin.enabled) {\n      try {\n        plugin.registerTools(toolRegistryV2);\n        log.info(`[PluginRegistry] Registered tools from plugin: ${plugin.id}`);\n      } catch (error) {\n        log.error(`[PluginRegistry] Failed to register tools from ${plugin.id}:`, error);\n      }\n    }\n\n    // Register panels if provided\n    if (plugin.registerPanels && plugin.enabled) {\n      try {\n        const panels = plugin.registerPanels();\n        panels.forEach(panel => {\n          this.panels.set(panel.id, panel);\n        });\n        log.info(`[PluginRegistry] Registered ${panels.length} panels from plugin: ${plugin.id}`);\n      } catch (error) {\n        log.error(`[PluginRegistry] Failed to register panels from ${plugin.id}:`, error);\n      }\n    }\n\n    log.info(`[PluginRegistry] Registered plugin: ${plugin.id} v${plugin.version}`);\n    track('plugin_registered', { pluginId: plugin.id, version: plugin.version });\n  }\n\n  /**\n   * Enable a plugin\n   */\n  async enable(pluginId: string): Promise<boolean> {\n    const plugin = this.plugins.get(pluginId);\n    if (!plugin) {\n      log.warn(`[PluginRegistry] Plugin not found: ${pluginId}`);\n      return false;\n    }\n\n    if (plugin.enabled) {\n      return true;\n    }\n\n    try {\n      plugin.enabled = true;\n\n      // Register tools\n      if (plugin.registerTools) {\n        plugin.registerTools(toolRegistryV2);\n      }\n\n      // Register panels\n      if (plugin.registerPanels) {\n        const panels = plugin.registerPanels();\n        panels.forEach(panel => {\n          this.panels.set(panel.id, panel);\n        });\n      }\n\n      // Call onEnable hook\n      if (plugin.onEnable) {\n        await plugin.onEnable();\n      }\n\n      this.persistPluginState();\n      log.info(`[PluginRegistry] Enabled plugin: ${pluginId}`);\n      track('plugin_enabled', { pluginId });\n\n      return true;\n    } catch (error) {\n      log.error(`[PluginRegistry] Failed to enable plugin ${pluginId}:`, error);\n      plugin.enabled = false;\n      return false;\n    }\n  }\n\n  /**\n   * Disable a plugin\n   */\n  async disable(pluginId: string): Promise<boolean> {\n    const plugin = this.plugins.get(pluginId);\n    if (!plugin) {\n      log.warn(`[PluginRegistry] Plugin not found: ${pluginId}`);\n      return false;\n    }\n\n    if (!plugin.enabled) {\n      return true;\n    }\n\n    try {\n      // Call onDisable hook\n      if (plugin.onDisable) {\n        await plugin.onDisable();\n      }\n\n      plugin.enabled = false;\n      this.persistPluginState();\n      log.info(`[PluginRegistry] Disabled plugin: ${pluginId}`);\n      track('plugin_disabled', { pluginId });\n\n      return true;\n    } catch (error) {\n      log.error(`[PluginRegistry] Failed to disable plugin ${pluginId}:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Get all plugins\n   */\n  getAll(): OmniPlugin[] {\n    return Array.from(this.plugins.values());\n  }\n\n  /**\n   * Get enabled plugins\n   */\n  getEnabled(): OmniPlugin[] {\n    return Array.from(this.plugins.values()).filter(p => p.enabled);\n  }\n\n  /**\n   * Get plugin by ID\n   */\n  get(pluginId: string): OmniPlugin | undefined {\n    return this.plugins.get(pluginId);\n  }\n\n  /**\n   * Get panels for a mode\n   */\n  getPanelsForMode(mode: string): PanelDefinition[] {\n    return Array.from(this.panels.values()).filter(panel => !panel.mode || panel.mode === mode);\n  }\n\n  /**\n   * Get all panels\n   */\n  getAllPanels(): PanelDefinition[] {\n    return Array.from(this.panels.values());\n  }\n\n  /**\n   * Load plugins from local folder\n   */\n  async loadFromFolder(folderPath: string): Promise<void> {\n    // TODO: Implement file system access (Electron) or fetch from server\n    log.info(`[PluginRegistry] Loading plugins from: ${folderPath}`);\n  }\n\n  /**\n   * Persist plugin state\n   */\n  private persistPluginState(): void {\n    const state = Array.from(this.plugins.values()).map(p => ({\n      id: p.id,\n      enabled: p.enabled,\n    }));\n    localStorage.setItem('regen_plugins_state', JSON.stringify(state));\n  }\n\n  /**\n   * Restore plugin state\n   */\n  restorePluginState(): void {\n    try {\n      const stored = localStorage.getItem('regen_plugins_state');\n      if (!stored) return;\n\n      const state = JSON.parse(stored) as Array<{ id: string; enabled: boolean }>;\n      state.forEach(({ id, enabled }) => {\n        const plugin = this.plugins.get(id);\n        if (plugin) {\n          plugin.enabled = enabled;\n        }\n      });\n    } catch (error) {\n      log.error('[PluginRegistry] Failed to restore plugin state:', error);\n    }\n  }\n}\n\n// Singleton instance\nexport const pluginRegistry = new PluginRegistry();\n"],"names":["PluginRegistry","__publicField","plugin","log","toolRegistryV2","error","panels","panel","track","pluginId","p","mode","folderPath","state","stored","id","enabled","pluginRegistry"],"mappings":"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"}