import{c as y}from"./vendor-zustand-BWsgwsXr.js";import{i as a}from"./core-ai-yFIunLTZ.js";import{i as n}from"../assets/index-D9cF9G1U.js";const d=(e,t)=>{const l={...e};for(const o of t)l[o.id]=o;return l},p=y((e,t)=>({profiles:[],profilesById:{},policies:{},activeProfileId:"default",loading:!1,async loadProfiles(l=!1){const{loading:o}=t();if(!(o&&!l)){e({loading:!0});try{const[s,i]=await Promise.all([a.profiles.list(),a.profiles.getActive()]),r=d(t().profilesById,s);i&&(r[i.id]=i);const c={...t().policies};for(const f of s)f.policy&&(c[f.id]=f.policy);if(i?.id&&!c[i.id])try{const f=await a.profiles.getPolicy(i.id);c[i.id]=f}catch(f){console.warn("[Profiles] Failed to fetch policy for active profile",f)}e({profiles:s,profilesById:r,policies:c,activeProfileId:i?.id??"default"})}catch(s){console.error("[Profiles] Failed to load profiles",s)}finally{e({loading:!1})}}},async setActiveProfile(l){try{const o=await a.profiles.setActive(l),s=o.policy??await a.profiles.getPolicy(o.id),i=d(t().profilesById,[o]);e(r=>({activeProfileId:o.id,profilesById:i,profiles:r.profiles.map(c=>c.id===o.id?{...c,...o}:c),policies:{...r.policies,[o.id]:s}}))}catch(o){throw console.error("[Profiles] Failed to activate profile",o),o}},markPolicyMessageRead(){e({lastPolicyBlock:void 0})}}));n.on("profiles:active",e=>{if(!e?.profileId)return;const t=p.getState(),{profileId:l,profile:o}=e,s=o.policy;p.setState(i=>({activeProfileId:l,profilesById:d(i.profilesById,[o]),profiles:i.profiles.some(r=>r.id===l)?i.profiles.map(r=>r.id===l?{...r,...o}:r):[...i.profiles,o],policies:s?{...i.policies,[l]:s}:i.policies})),!t.policies[l]&&!s&&a.profiles.getPolicy(l).then(i=>{p.setState(r=>({policies:{...r.policies,[l]:i}}))}).catch(i=>console.warn("[Profiles] Failed to refresh policy",i))});n.on("profiles:policy-blocked",e=>{!e?.profileId||!e?.action||p.setState({lastPolicyBlock:{action:e.action,profileId:e.profileId,timestamp:Date.now()}})});export{p as u};
//# sourceMappingURL=profileStore-CltTxMCZ.js.map
