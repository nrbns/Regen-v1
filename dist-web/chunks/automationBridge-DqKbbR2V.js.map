{"version":3,"file":"automationBridge-DqKbbR2V.js","sources":["../../src/services/automationBridge.ts"],"sourcesContent":["/**\r\n * Automation Bridge - Connects PlaybookForge to AgentConsole\r\n * Handles automation execution, status, and feedback\r\n */\r\n\r\nimport { useAgentStreamStore } from '../state/agentStreamStore';\r\nimport { toast } from '../utils/toast';\r\n\r\nexport interface AutomationPlaybook {\r\n  id: string;\r\n  title: string;\r\n  goal: string;\r\n  steps: Array<{\r\n    skill: string;\r\n    args: Record<string, any>;\r\n  }>;\r\n  output?: {\r\n    type: string;\r\n    schema?: Record<string, any>;\r\n  };\r\n}\r\n\r\nexport type AutomationStatus = 'idle' | 'running' | 'success' | 'error' | 'cancelled';\r\n\r\nexport interface AutomationExecution {\r\n  id: string;\r\n  playbookId: string;\r\n  status: AutomationStatus;\r\n  startTime: number;\r\n  endTime?: number;\r\n  error?: string;\r\n  result?: any;\r\n  progress?: number;\r\n}\r\n\r\n// Global automation state\r\nlet currentExecution: AutomationExecution | null = null;\r\nconst executionListeners: Set<(execution: AutomationExecution | null) => void> = new Set();\r\n\r\n/**\r\n * Execute an automation playbook\r\n */\r\nexport async function executeAutomation(playbook: AutomationPlaybook): Promise<string> {\r\n  const executionId = `auto-${Date.now()}-${Math.random().toString(36).slice(2)}`;\r\n  \r\n  currentExecution = {\r\n    id: executionId,\r\n    playbookId: playbook.id || executionId,\r\n    status: 'running',\r\n    startTime: Date.now(),\r\n    progress: 0,\r\n  };\r\n\r\n  notifyListeners();\r\n\r\n  try {\r\n    // Navigate to AgentConsole if not already there\r\n    if (typeof window !== 'undefined') {\r\n      window.dispatchEvent(new CustomEvent('navigate-to-agent-console'));\r\n    }\r\n\r\n    // Use AgentConsole's execution system\r\n    const agentStore = useAgentStreamStore.getState();\r\n    agentStore.setRun(executionId, playbook.goal);\r\n    agentStore.setStatus('connecting'); // Will transition to 'live' when execution starts\r\n\r\n    // Parse and execute the playbook\r\n    const dsl = {\r\n      goal: playbook.goal,\r\n      steps: playbook.steps,\r\n      output: playbook.output,\r\n    };\r\n\r\n    // Trigger agent execution via window event (AgentConsole listens for this)\r\n    window.dispatchEvent(\r\n      new CustomEvent('agent:execute', {\r\n        detail: {\r\n          runId: executionId,\r\n          dsl,\r\n          playbookTitle: playbook.title,\r\n        },\r\n      })\r\n    );\r\n\r\n    toast.success(`Starting automation: ${playbook.title}`);\r\n    return executionId;\r\n  } catch (error) {\r\n    currentExecution = {\r\n      ...currentExecution!,\r\n      status: 'error',\r\n      endTime: Date.now(),\r\n      error: error instanceof Error ? error.message : 'Unknown error',\r\n    };\r\n    notifyListeners();\r\n    toast.error(`Automation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get current automation execution status\r\n */\r\nexport function getAutomationStatus(): AutomationExecution | null {\r\n  return currentExecution;\r\n}\r\n\r\n/**\r\n * Subscribe to automation status updates\r\n */\r\nexport function onAutomationStatusUpdate(\r\n  callback: (execution: AutomationExecution | null) => void\r\n): () => void {\r\n  executionListeners.add(callback);\r\n  return () => {\r\n    executionListeners.delete(callback);\r\n  };\r\n}\r\n\r\n/**\r\n * Update automation execution status\r\n */\r\nexport function updateAutomationStatus(\r\n  executionId: string,\r\n  updates: Partial<AutomationExecution>\r\n): void {\r\n  if (currentExecution && currentExecution.id === executionId) {\r\n    currentExecution = { ...currentExecution, ...updates };\r\n    notifyListeners();\r\n  }\r\n}\r\n\r\n/**\r\n * Cancel current automation\r\n */\r\nexport function cancelAutomation(): void {\r\n  if (currentExecution && currentExecution.status === 'running') {\r\n    currentExecution = {\r\n      ...currentExecution,\r\n      status: 'cancelled',\r\n      endTime: Date.now(),\r\n    };\r\n    notifyListeners();\r\n\r\n    // Cancel agent execution\r\n    window.dispatchEvent(new CustomEvent('agent:cancel'));\r\n    toast.info('Automation cancelled');\r\n  }\r\n}\r\n\r\n/**\r\n * Complete automation execution\r\n */\r\nexport function completeAutomation(executionId: string, result?: any, error?: string): void {\r\n  if (currentExecution && currentExecution.id === executionId) {\r\n    currentExecution = {\r\n      ...currentExecution,\r\n      status: error ? 'error' : 'success',\r\n      endTime: Date.now(),\r\n      result,\r\n      error,\r\n      progress: 100,\r\n    };\r\n    notifyListeners();\r\n\r\n    if (error) {\r\n      toast.error(`Automation failed: ${error}`);\r\n    } else {\r\n      toast.success('Automation completed successfully');\r\n    }\r\n  }\r\n}\r\n\r\nfunction notifyListeners(): void {\r\n  executionListeners.forEach(callback => {\r\n    try {\r\n      callback(currentExecution);\r\n    } catch (error) {\r\n      console.error('[AutomationBridge] Error in listener:', error);\r\n    }\r\n  });\r\n}\r\n\r\n"],"names":["currentExecution","executionListeners","executeAutomation","playbook","executionId","notifyListeners","agentStore","useAgentStreamStore","dsl","toast","error","getAutomationStatus","onAutomationStatusUpdate","callback","updateAutomationStatus","updates","completeAutomation","result"],"mappings":"qQAoCA,IAAIA,EAA+C,KACnD,MAAMC,MAA+E,IAKrF,eAAsBC,EAAkBC,EAA+C,CACrF,MAAMC,EAAc,QAAQ,KAAK,IAAA,CAAK,IAAI,KAAK,OAAA,EAAS,SAAS,EAAE,EAAE,MAAM,CAAC,CAAC,GAE7EJ,EAAmB,CACjB,GAAII,EACJ,WAAYD,EAAS,IAAMC,EAC3B,OAAQ,UACR,UAAW,KAAK,IAAA,EAChB,SAAU,CAAA,EAGZC,EAAA,EAEA,GAAI,CAEE,OAAO,OAAW,KACpB,OAAO,cAAc,IAAI,YAAY,2BAA2B,CAAC,EAInE,MAAMC,EAAaC,EAAoB,SAAA,EACvCD,EAAW,OAAOF,EAAaD,EAAS,IAAI,EAC5CG,EAAW,UAAU,YAAY,EAGjC,MAAME,EAAM,CACV,KAAML,EAAS,KACf,MAAOA,EAAS,MAChB,OAAQA,EAAS,MAAA,EAInB,cAAO,cACL,IAAI,YAAY,gBAAiB,CAC/B,OAAQ,CACN,MAAOC,EACP,IAAAI,EACA,cAAeL,EAAS,KAAA,CAC1B,CACD,CAAA,EAGHM,EAAM,QAAQ,wBAAwBN,EAAS,KAAK,EAAE,EAC/CC,CACT,OAASM,EAAO,CACd,MAAAV,EAAmB,CACjB,GAAGA,EACH,OAAQ,QACR,QAAS,KAAK,IAAA,EACd,MAAOU,aAAiB,MAAQA,EAAM,QAAU,eAAA,EAElDL,EAAA,EACAI,EAAM,MAAM,sBAAsBC,aAAiB,MAAQA,EAAM,QAAU,eAAe,EAAE,EACtFA,CACR,CACF,CAKO,SAASC,GAAkD,CAChE,OAAOX,CACT,CAKO,SAASY,EACdC,EACY,CACZ,OAAAZ,EAAmB,IAAIY,CAAQ,EACxB,IAAM,CACXZ,EAAmB,OAAOY,CAAQ,CACpC,CACF,CAKO,SAASC,EACdV,EACAW,EACM,CACFf,GAAoBA,EAAiB,KAAOI,IAC9CJ,EAAmB,CAAE,GAAGA,EAAkB,GAAGe,CAAA,EAC7CV,EAAA,EAEJ,CAuBO,SAASW,EAAmBZ,EAAqBa,EAAcP,EAAsB,CACtFV,GAAoBA,EAAiB,KAAOI,IAC9CJ,EAAmB,CACjB,GAAGA,EACH,OAAQU,EAAQ,QAAU,UAC1B,QAAS,KAAK,IAAA,EACd,OAAAO,EACA,MAAAP,EACA,SAAU,GAAA,EAEZL,EAAA,EAEIK,EACFD,EAAM,MAAM,sBAAsBC,CAAK,EAAE,EAEzCD,EAAM,QAAQ,mCAAmC,EAGvD,CAEA,SAASJ,GAAwB,CAC/BJ,EAAmB,QAAQY,GAAY,CACrC,GAAI,CACFA,EAASb,CAAgB,CAC3B,OAASU,EAAO,CACd,QAAQ,MAAM,wCAAyCA,CAAK,CAC9D,CACF,CAAC,CACH"}