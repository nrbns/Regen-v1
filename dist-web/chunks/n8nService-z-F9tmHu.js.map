{"version":3,"file":"n8nService-z-F9tmHu.js","sources":["../../src/services/n8nService.ts"],"sourcesContent":["/**\n * n8n Workflow Service\n * Handles workflow calls, loops, and execution\n */\n\nexport interface N8nWorkflowConfig {\n  baseUrl?: string;\n  webhookUrl?: string;\n  apiKey?: string;\n  workflowId?: string;\n}\n\nexport interface N8nWorkflowCall {\n  workflowId: string;\n  data: Record<string, unknown>;\n  language?: string;\n  sourceMode?: string;\n  metadata?: Record<string, unknown>;\n}\n\nexport interface N8nWorkflowResult {\n  success: boolean;\n  workflowId: string;\n  data?: unknown;\n  error?: string;\n  executionId?: string;\n}\n\nexport interface N8nLoopConfig {\n  workflowId: string;\n  interval?: number; // milliseconds\n  maxIterations?: number;\n  condition?: (result: N8nWorkflowResult) => boolean; // Continue loop if true\n  onIteration?: (result: N8nWorkflowResult, iteration: number) => void;\n  onComplete?: (results: N8nWorkflowResult[]) => void;\n  onError?: (error: Error) => void;\n}\n\n/**\n * Get n8n configuration from environment or settings\n */\nfunction getN8nConfig(): N8nWorkflowConfig {\n  const baseUrl =\n    import.meta.env.VITE_N8N_BASE_URL || import.meta.env.N8N_BASE_URL || 'http://localhost:5678';\n  const webhookUrl =\n    import.meta.env.VITE_N8N_WEBHOOK_URL || import.meta.env.N8N_WEBHOOK_URL || `${baseUrl}/webhook`;\n  const apiKey = import.meta.env.VITE_N8N_API_KEY || import.meta.env.N8N_API_KEY;\n\n  return {\n    baseUrl,\n    webhookUrl,\n    apiKey,\n  };\n}\n\n/**\n * Call an n8n workflow via webhook\n */\nexport async function callN8nWorkflow(\n  call: N8nWorkflowCall,\n  config?: N8nWorkflowConfig\n): Promise<N8nWorkflowResult> {\n  const n8nConfig = { ...getN8nConfig(), ...config };\n\n  if (!call.workflowId) {\n    return {\n      success: false,\n      workflowId: call.workflowId || 'unknown',\n      error: 'Workflow ID is required',\n    };\n  }\n\n  try {\n    // Build webhook URL\n    const webhookUrl = n8nConfig.webhookUrl || `${n8nConfig.baseUrl}/webhook`;\n    const url = `${webhookUrl}/${call.workflowId}`;\n\n    // Prepare request body\n    const body = {\n      ...call.data,\n      language: call.language,\n      sourceMode: call.sourceMode,\n      metadata: call.metadata,\n      timestamp: Date.now(),\n    };\n\n    // Make request\n    const headers: HeadersInit = {\n      'Content-Type': 'application/json',\n    };\n\n    // Add API key if available\n    if (n8nConfig.apiKey) {\n      headers['X-N8N-API-KEY'] = n8nConfig.apiKey;\n    }\n\n    const response = await fetch(url, {\n      method: 'POST',\n      headers,\n      body: JSON.stringify(body),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text().catch(() => 'Unknown error');\n      throw new Error(`n8n workflow returned ${response.status}: ${errorText}`);\n    }\n\n    const result = await response.json().catch(() => ({}));\n\n    return {\n      success: true,\n      workflowId: call.workflowId,\n      data: result,\n      executionId: result.executionId || result.id,\n    };\n  } catch (error) {\n    console.error('[N8nService] Workflow call failed:', error);\n    return {\n      success: false,\n      workflowId: call.workflowId,\n      error: error instanceof Error ? error.message : String(error),\n    };\n  }\n}\n\n/**\n * Execute an n8n workflow in a loop\n * Continues until condition returns false or maxIterations is reached\n */\nexport async function runN8nWorkflowLoop(\n  call: N8nWorkflowCall,\n  loopConfig: N8nLoopConfig,\n  config?: N8nWorkflowConfig\n): Promise<N8nWorkflowResult[]> {\n  const results: N8nWorkflowResult[] = [];\n  const interval = loopConfig.interval || 1000; // Default 1 second\n  const maxIterations = loopConfig.maxIterations || 10; // Default 10 iterations\n\n  let iteration = 0;\n  let shouldContinue = true;\n\n  while (shouldContinue && iteration < maxIterations) {\n    iteration++;\n\n    try {\n      // Call workflow\n      const result = await callN8nWorkflow(call, config);\n      results.push(result);\n\n      // Call iteration callback\n      if (loopConfig.onIteration) {\n        loopConfig.onIteration(result, iteration);\n      }\n\n      // Check condition\n      if (loopConfig.condition) {\n        shouldContinue = loopConfig.condition(result);\n      } else {\n        // Default: continue if successful\n        shouldContinue = result.success;\n      }\n\n      // If continuing, wait for interval\n      if (shouldContinue && iteration < maxIterations) {\n        await new Promise(resolve => setTimeout(resolve, interval));\n      }\n    } catch (error) {\n      const errorResult: N8nWorkflowResult = {\n        success: false,\n        workflowId: call.workflowId,\n        error: error instanceof Error ? error.message : String(error),\n      };\n      results.push(errorResult);\n\n      if (loopConfig.onError) {\n        loopConfig.onError(error instanceof Error ? error : new Error(String(error)));\n      }\n\n      // Stop loop on error unless condition says otherwise\n      if (!loopConfig.condition || !loopConfig.condition(errorResult)) {\n        shouldContinue = false;\n      }\n    }\n  }\n\n  // Call completion callback\n  if (loopConfig.onComplete) {\n    loopConfig.onComplete(results);\n  }\n\n  return results;\n}\n\n/**\n * List available n8n workflows (requires n8n API)\n */\nexport async function listN8nWorkflows(\n  config?: N8nWorkflowConfig\n): Promise<Array<{ id: string; name: string; description?: string }>> {\n  const n8nConfig = { ...getN8nConfig(), ...config };\n\n  if (!n8nConfig.apiKey) {\n    console.warn('[N8nService] API key not configured, cannot list workflows');\n    return [];\n  }\n\n  try {\n    const url = `${n8nConfig.baseUrl}/api/v1/workflows`;\n    const response = await fetch(url, {\n      headers: {\n        'X-N8N-API-KEY': n8nConfig.apiKey,\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`n8n API returned ${response.status}`);\n    }\n\n    const workflows = await response.json();\n    return Array.isArray(workflows)\n      ? workflows.map((w: any) => ({\n          id: w.id || w.name,\n          name: w.name || 'Unnamed Workflow',\n          description: w.description,\n        }))\n      : [];\n  } catch (error) {\n    console.error('[N8nService] Failed to list workflows:', error);\n    return [];\n  }\n}\n\n/**\n * Get workflow execution status\n */\nexport async function getN8nWorkflowExecution(\n  executionId: string,\n  config?: N8nWorkflowConfig\n): Promise<{ status: string; data?: unknown } | null> {\n  const n8nConfig = { ...getN8nConfig(), ...config };\n\n  if (!n8nConfig.apiKey) {\n    return null;\n  }\n\n  try {\n    const url = `${n8nConfig.baseUrl}/api/v1/executions/${executionId}`;\n    const response = await fetch(url, {\n      headers: {\n        'X-N8N-API-KEY': n8nConfig.apiKey,\n      },\n    });\n\n    if (!response.ok) {\n      return null;\n    }\n\n    const execution = await response.json();\n    return {\n      status: execution.finished ? 'finished' : 'running',\n      data: execution.data,\n    };\n  } catch (error) {\n    console.error('[N8nService] Failed to get execution status:', error);\n    return null;\n  }\n}\n"],"names":["getN8nConfig","baseUrl","webhookUrl","callN8nWorkflow","call","config","n8nConfig","url","body","headers","response","errorText","result","error","runN8nWorkflowLoop","loopConfig","results","interval","maxIterations","iteration","shouldContinue","resolve","errorResult","listN8nWorkflows","workflows","w"],"mappings":"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"}