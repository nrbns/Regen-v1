import{ay as v,az as y,aA as u}from"./vendor-Vl2WtvH-.js";import{a as l}from"./core-ai-yFIunLTZ.js";import"./vendor-react-gmX1Lmvt.js";import"./vendor-react-dom-Bkb6jJ_S.js";import"./vendor-zustand-BWsgwsXr.js";import"./mode-manager.ts-DwguZmJt.js";import"./core-memory-DmK-uh9X.js";var g=Object.defineProperty,p=(o,s,i)=>s in o?g(o,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[s]=i,c=(o,s,i)=>p(o,typeof s!="symbol"?s+"":s,i);class f{constructor(s="ws://127.0.0.1:18080/yjs"){c(this,"doc",null),c(this,"provider",null),c(this,"tabsArray",null),c(this,"activeId",null),c(this,"groupsArray",null),c(this,"isConnected",!1),c(this,"wsUrl"),this.wsUrl=s}async initialize(s){if(this.doc)return;this.doc=new v,this.tabsArray=this.doc.getArray("tabs"),this.activeId=this.doc.getText("activeId"),this.groupsArray=this.doc.getArray("groups"),this.provider=new y(this.wsUrl,`session-${s}`,this.doc),this.provider.on("status",t=>{this.isConnected=t.status==="connected",console.log("[TabSync] Connection status:",t.status)}),this.tabsArray.observe(t=>{this.syncFromYjs()}),this.activeId.observe(()=>{const t=this.activeId?.toString()||null,e=l.getState();t&&t!==e.activeId&&e.setActive(t)}),this.groupsArray.observe(()=>{this.syncFromYjs()}),this.syncToYjs();const i=l.getState();let n=i.tabs,a=i.activeId,r=i.tabGroups;l.subscribe(t=>{(t.tabs!==n||t.activeId!==a||t.tabGroups!==r)&&(this.syncToYjs(),n=t.tabs,a=t.activeId,r=t.tabGroups)}),console.log("[TabSync] Initialized with session:",s)}syncToYjs(){if(!this.doc||!this.tabsArray||!this.activeId||!this.groupsArray){console.warn("[TabSync] Cannot sync to Yjs: missing required Yjs structures");return}const s=l.getState(),i=this.tabsArray,n=this.activeId,a=this.groupsArray;this.doc.transact(()=>{i.delete(0,i.length),s.tabs.forEach((r,t)=>{const e=new u;e.set("id",r.id),e.set("title",r.title||""),e.set("url",r.url||""),e.set("order",t),i.push([e])}),n.delete(0,n.length),s.activeId&&n.insert(0,s.activeId),a.delete(0,a.length),s.tabGroups.forEach(r=>{const t=new u;t.set("id",r.id),t.set("name",r.name),t.set("color",r.color);const e=s.tabs.filter(d=>d.groupId===r.id).map(d=>d.id);t.set("tabIds",e),a.push([t])})})}syncFromYjs(){if(!this.tabsArray||!this.activeId||!this.groupsArray)return;const s=l.getState(),i=this.tabsArray.toArray().map(t=>({id:t.get("id"),title:t.get("title")||"",url:t.get("url"),order:t.get("order")||0})),n=s.tabs;if(i.length!==n.length||i.some((t,e)=>t.id!==n[e]?.id||t.order!==e)){const t=i.sort((e,d)=>e.order-d.order).map(e=>n.find(b=>b.id===e.id)||{...e,id:e.id,title:e.title,url:e.url});s.setAll(t)}const a=this.activeId.toString()||null;a&&a!==s.activeId&&s.setActive(a);const r=this.groupsArray.toArray().map(t=>({id:t.get("id"),name:t.get("name")||"",color:t.get("color")||"#6366f1",tabIds:t.get("tabIds")||[]}));console.log("[TabSync] Groups synced:",r)}disconnect(){this.provider&&(this.provider.destroy(),this.provider=null),this.doc&&(this.doc.destroy(),this.doc=null),this.isConnected=!1,console.log("[TabSync] Disconnected")}getStatus(){return{connected:this.isConnected}}}let h=null;function A(o){return h||(h=new f(o)),h}function G(o,s){return A(s).initialize(o)}export{A as getTabSyncService,G as initializeTabSync};
//# sourceMappingURL=tabSyncService-lTHTJeOg.js.map
