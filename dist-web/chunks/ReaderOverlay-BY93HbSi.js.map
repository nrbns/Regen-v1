{"version":3,"mappings":"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","names":["ReaderOverlay","active","onClose","tabId","url","article","setArticle","useState","loading","setLoading","error","setError","summary","setSummary","summaryMode","setSummaryMode","summaryLoading","setSummaryLoading","summaryError","setSummaryError","exporting","setExporting","exportMessage","setExportMessage","tabsStore","useTabsStore","activeTab","useMemo","useEffect","result","ipc","ipcError","redixUrl","redixResponse","redixData","redixError","extractPageContent","__vitePreload","pageMeta","extractError","sanitizeText","err","handleSummarize","sendPrompt","n","prompt","bullets","line","handleExport","handleOpenCitation","link","jsx","AnimatePresence","jsxs","Fragment","motion","BookOpen","getHostname","Loader2","Download","Sparkles","X","RefreshCcw","AlertTriangle","bullet","idx","Quote","ExternalLink","text","input"],"ignoreList":[],"sources":["../../src/components/Overlays/ReaderOverlay.tsx"],"sourcesContent":["import { useEffect, useMemo, useState } from 'react';\r\nimport { AnimatePresence, motion } from 'framer-motion';\r\nimport {\r\n  BookOpen,\r\n  Loader2,\r\n  Sparkles,\r\n  Download,\r\n  RefreshCcw,\r\n  X,\r\n  ExternalLink,\r\n  Quote,\r\n  AlertTriangle,\r\n} from 'lucide-react';\r\nimport { ipc } from '../../lib/ipc-typed';\r\nimport { useTabsStore } from '../../state/tabsStore';\r\n\r\ntype SummaryBullet = {\r\n  summary: string;\r\n  citation?: {\r\n    text: string;\r\n    url?: string;\r\n  };\r\n};\r\n\r\ninterface ReaderOverlayProps {\r\n  active: boolean;\r\n  onClose: () => void;\r\n  tabId?: string | null;\r\n  url?: string | null;\r\n}\r\n\r\ninterface ArticleState {\r\n  title: string;\r\n  html: string;\r\n  content: string;\r\n  url?: string;\r\n}\r\n\r\nexport function ReaderOverlay({ active, onClose, tabId, url }: ReaderOverlayProps) {\r\n  const [article, setArticle] = useState<ArticleState | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [summary, setSummary] = useState<SummaryBullet[]>([]);\r\n  const [summaryMode, setSummaryMode] = useState<'local' | 'cloud' | 'extractive' | null>(null);\r\n  const [summaryLoading, setSummaryLoading] = useState(false);\r\n  const [summaryError, setSummaryError] = useState<string | null>(null);\r\n  const [exporting, setExporting] = useState(false);\r\n  const [exportMessage, setExportMessage] = useState<string | null>(null);\r\n  const tabsStore = useTabsStore();\r\n  const activeTab = useMemo(\r\n    () => tabsStore.tabs.find((t) => t.id === tabId),\r\n    [tabsStore.tabs, tabId],\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!active) {\r\n      setArticle(null);\r\n      setSummary([]);\r\n      setSummaryMode(null);\r\n      setSummaryError(null);\r\n      setExportMessage(null);\r\n      return;\r\n    }\r\n    if (!tabId) {\r\n      setError('No active tab to read.');\r\n      return;\r\n    }\r\n\r\n    const load = async () => {\r\n      setLoading(true);\r\n      setError(null);\r\n      setSummary([]);\r\n      setSummaryMode(null);\r\n      setSummaryError(null);\r\n      try {\r\n        // Try extraction via IPC (Electron) first\r\n        let result;\r\n        try {\r\n          // Use research:extractContent IPC call if available\r\n          if (tabId && typeof window !== 'undefined' && (window as any).ipc) {\r\n            try {\r\n              result = await ipc.research.extractContent(tabId);\r\n            } catch (ipcError) {\r\n              console.warn('[ReaderOverlay] IPC extractContent failed, trying Redix fallback:', ipcError);\r\n              \r\n              // Try Redix /extract endpoint if available\r\n              const redixUrl = import.meta.env.VITE_REDIX_CORE_URL || 'http://localhost:8001';\r\n              try {\r\n                const redixResponse = await fetch(`${redixUrl}/extract`, {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                    url: activeTab?.url || url,\r\n                    tabId,\r\n                  }),\r\n                }).catch(() => null);\r\n                \r\n                if (redixResponse?.ok) {\r\n                  const redixData = await redixResponse.json();\r\n                  if (redixData.title || redixData.content) {\r\n                    result = {\r\n                      title: redixData.title || activeTab?.title,\r\n                      content: redixData.content || redixData.text,\r\n                      html: redixData.html || `<h1>${redixData.title}</h1><p>${redixData.content}</p>`,\r\n                    };\r\n                  }\r\n                }\r\n              } catch (redixError) {\r\n                console.debug('[ReaderOverlay] Redix extract also failed:', redixError);\r\n              }\r\n            }\r\n          }\r\n        } catch {\r\n          // Continue to fallback\r\n        }\r\n        \r\n        // Fallback: Try to use page extractor from document\r\n        if (!result && typeof window !== 'undefined' && window.document) {\r\n          try {\r\n            const { extractPageContent } = await import('../../utils/pageExtractor');\r\n            const pageMeta = extractPageContent(window.document, activeTab?.url || url || undefined);\r\n            result = {\r\n              title: pageMeta.title,\r\n              content: pageMeta.mainContent,\r\n              html: `<h1>${pageMeta.title}</h1>\\n<p>${pageMeta.mainContent}</p>`,\r\n            };\r\n          } catch (extractError) {\r\n            console.warn('[ReaderOverlay] Page extractor fallback failed:', extractError);\r\n          }\r\n        }\r\n        \r\n        // Final fallback: Use tab title/URL if available\r\n        if (!result && activeTab) {\r\n          result = {\r\n            title: activeTab.title || 'Reader View',\r\n            content: `Content from: ${activeTab.url || 'Current page'}\\n\\nUnable to extract readable content. Please ensure the page has loaded completely.`,\r\n            html: `<h1>${activeTab.title || 'Reader View'}</h1>\\n<p>Content from: <a href=\"${activeTab.url}\">${activeTab.url}</a></p>\\n<p>Unable to extract readable content. Please ensure the page has loaded completely.</p>`,\r\n          };\r\n        }\r\n        \r\n        if (!result || (!result.content && !result.html)) {\r\n          setError('Unable to extract article content for this page. The page may not have readable content, or it may still be loading.');\r\n          return;\r\n        }\r\n        \r\n        setArticle({\r\n          title: result.title || activeTab?.title || activeTab?.url || 'Reader View',\r\n          html: result.html || `<p>${sanitizeText(result.content)}</p>`,\r\n          content: result.content || '',\r\n          url: activeTab?.url || url || undefined,\r\n        });\r\n      } catch (err) {\r\n        console.error('Failed to load reader content:', err);\r\n        setError('Failed to load reader view for this page. Please try again or ensure the page has loaded.');\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    void load();\r\n  }, [active, tabId, activeTab, url]);\r\n\r\n  const handleSummarize = async () => {\r\n    if (!article?.content) return;\r\n    setSummaryLoading(true);\r\n    setSummaryError(null);\r\n    setExportMessage(null);\r\n    try {\r\n      // Try using LLM adapter first, fallback to IPC\r\n      try {\r\n        const { sendPrompt } = await import('../../core/llm/adapter');\r\n        const prompt = `Summarize the following article in 3-5 bullet points:\\n\\nTitle: ${article.title}\\n\\n${article.content}`;\r\n        const response = await sendPrompt(prompt, {\r\n          systemPrompt: 'You are a helpful assistant that creates concise summaries of web articles.',\r\n          maxTokens: 300,\r\n        });\r\n        \r\n        // Parse bullet points from response\r\n        const bullets = response.text\r\n          .split(/\\n/)\r\n          .filter(line => line.trim().match(/^[-•*]\\s|^\\d+\\.\\s/))\r\n          .map(line => ({\r\n            summary: line.replace(/^[-•*]\\s|^\\d+\\.\\s/, '').trim(),\r\n            citation: { text: article.title, url: article.url },\r\n          }));\r\n        \r\n        if (bullets.length > 0) {\r\n          setSummary(bullets);\r\n          setSummaryMode('cloud');\r\n          return;\r\n        }\r\n      } catch {\r\n        // Fallback to IPC\r\n      }\r\n      \r\n      // Fallback to IPC method\r\n      const result = await ipc.reader.summarize({\r\n        url: article.url,\r\n        title: article.title,\r\n        content: article.content,\r\n        html: article.html,\r\n      });\r\n      setSummary(result.bullets);\r\n      setSummaryMode(result.mode);\r\n    } catch (err) {\r\n      console.error('Failed to summarize article:', err);\r\n      setSummaryError('Summarization failed. Try again or check AI settings.');\r\n    } finally {\r\n      setSummaryLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleExport = async () => {\r\n    if (!article?.html) return;\r\n    setExporting(true);\r\n    setExportMessage(null);\r\n    try {\r\n      const result = await ipc.reader.export({\r\n        url: article.url,\r\n        title: article.title,\r\n        html: article.html,\r\n      });\r\n      if (result?.success) {\r\n        setExportMessage(`Saved clean copy to ${result.path}`);\r\n      } else {\r\n        setExportMessage('Export failed. Please try again.');\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to export reader view:', err);\r\n      setExportMessage('Export failed. Please try again.');\r\n    } finally {\r\n      setExporting(false);\r\n    }\r\n  };\r\n\r\n  const handleOpenCitation = (link?: string) => {\r\n    if (!link) return;\r\n    ipc.tabs.create({ url: link, mode: 'normal' }).catch(console.error);\r\n    onClose();\r\n  };\r\n\r\n  if (!active) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <AnimatePresence>\r\n      {active && (\r\n        <>\r\n          <motion.div\r\n            initial={{ opacity: 0 }}\r\n            animate={{ opacity: 0.6 }}\r\n            exit={{ opacity: 0 }}\r\n            className=\"fixed inset-0 z-[70] bg-gray-950\"\r\n            onClick={onClose}\r\n          />\r\n          <motion.div\r\n            initial={{ opacity: 0, y: 32 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            exit={{ opacity: 0, y: 32 }}\r\n            transition={{ duration: 0.18 }}\r\n            className=\"fixed inset-8 z-[80] rounded-2xl border border-gray-800/70 bg-[#0B1120]/98 shadow-2xl backdrop-blur-xl overflow-hidden flex flex-col\"\r\n          >\r\n            <div className=\"flex items-center justify-between px-6 py-4 border-b border-gray-800/60 bg-gray-900/40\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-blue-500/20 border border-blue-500/30\">\r\n                  <BookOpen size={20} className=\"text-blue-200\" />\r\n                </div>\r\n                <div>\r\n                  <h2 className=\"text-xl font-semibold text-gray-100\">\r\n                    {article?.title || activeTab?.title || 'Reader'}\r\n                  </h2>\r\n                  <div className=\"text-xs text-gray-500\">\r\n                    {article?.url ? getHostname(article.url) : activeTab?.url}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <button\r\n                  onClick={handleExport}\r\n                  disabled={!article?.html || exporting}\r\n                  className=\"flex items-center gap-2 px-3 py-2 text-sm rounded-lg border border-gray-700/60 bg-gray-800/50 hover:bg-gray-800/70 text-gray-200 disabled:opacity-60 disabled:cursor-not-allowed transition-colors\"\r\n                >\r\n                  {exporting ? <Loader2 size={16} className=\"animate-spin\" /> : <Download size={16} />}\r\n                  Export clean view\r\n                </button>\r\n                <button\r\n                  onClick={() => void handleSummarize()}\r\n                  disabled={!article?.content || summaryLoading}\r\n                  className=\"flex items-center gap-2 px-3 py-2 text-sm rounded-lg bg-blue-600/70 hover:bg-blue-600 text-blue-50 border border-blue-500/40 disabled:opacity-60 disabled:cursor-not-allowed transition-colors\"\r\n                >\r\n                  {summaryLoading ? <Loader2 size={16} className=\"animate-spin\" /> : <Sparkles size={16} />}\r\n                  Cite-preserving summary\r\n                </button>\r\n                <button\r\n                  onClick={onClose}\r\n                  className=\"p-2 rounded-lg hover:bg-gray-800/60 text-gray-400 hover:text-gray-200 transition-colors\"\r\n                  title=\"Close reader\"\r\n                >\r\n                  <X size={18} />\r\n                </button>\r\n              </div>\r\n            </div>\r\n\r\n            {exportMessage && (\r\n              <div className=\"px-6 py-3 bg-emerald-500/10 border-b border-emerald-500/20 text-sm text-emerald-200 flex items-center justify-between\">\r\n                <span>{exportMessage}</span>\r\n                <button\r\n                  onClick={() => setExportMessage(null)}\r\n                  className=\"text-emerald-300 hover:text-emerald-100\"\r\n                >\r\n                  Dismiss\r\n                </button>\r\n              </div>\r\n            )}\r\n\r\n            {error ? (\r\n              <div className=\"flex-1 flex items-center justify-center text-sm text-red-300 bg-red-500/10\">\r\n                {error}\r\n              </div>\r\n            ) : (\r\n              <div className=\"flex-1 grid grid-cols-1 lg:grid-cols-[2fr_1fr] overflow-hidden\">\r\n                <div className=\"relative overflow-y-auto\">\r\n                  {loading && (\r\n                    <div className=\"absolute inset-0 flex items-center justify-center bg-gray-950/60 backdrop-blur-sm z-10\">\r\n                      <Loader2 size={32} className=\"text-blue-400 animate-spin\" />\r\n                    </div>\r\n                  )}\r\n                  <div className=\"prose prose-invert max-w-none px-8 py-6\">\r\n                    {article ? (\r\n                      <div\r\n                        className=\"reader-article\"\r\n                        dangerouslySetInnerHTML={{ __html: article.html }}\r\n                      />\r\n                    ) : (\r\n                      <div className=\"text-center text-gray-500 text-sm py-12\">\r\n                        Preparing clean article view…\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n                <aside className=\"border-l border-gray-800/60 bg-gray-900/30 flex flex-col overflow-hidden\">\r\n                  <div className=\"flex items-center justify-between px-5 py-4 border-b border-gray-800/50\">\r\n                    <div>\r\n                      <div className=\"text-sm font-semibold text-gray-100 flex items-center gap-2\">\r\n                        <Sparkles size={16} className=\"text-blue-300\" />\r\n                        Summary with citations\r\n                      </div>\r\n                      <div className=\"text-xs text-gray-500\">\r\n                        {summaryMode === 'local' && 'Generated locally (GGUF)'}\r\n                        {summaryMode === 'cloud' && 'Generated via cloud model (with consent)'}\r\n                        {summaryMode === 'extractive' && 'Extractive summary from source paragraphs'}\r\n                        {!summaryMode && 'Click summarize to generate key bullet points'}\r\n                      </div>\r\n                    </div>\r\n                    <button\r\n                      onClick={() => void handleSummarize()}\r\n                      disabled={!article?.content || summaryLoading}\r\n                      className=\"p-2 rounded-lg border border-gray-700/50 text-gray-300 hover:text-gray-100 hover:bg-gray-800/60 disabled:opacity-50\"\r\n                      title=\"Refresh summary\"\r\n                    >\r\n                      <RefreshCcw size={16} className={summaryLoading ? 'animate-spin' : ''} />\r\n                    </button>\r\n                  </div>\r\n                  <div className=\"flex-1 overflow-y-auto px-5 py-4 space-y-4\">\r\n                    {summaryLoading && (\r\n                      <div className=\"flex items-center justify-center h-full text-sm text-gray-400 gap-2\">\r\n                        <Loader2 size={18} className=\"animate-spin\" />\r\n                        Generating summary…\r\n                      </div>\r\n                    )}\r\n                    {summaryError && (\r\n                      <div className=\"flex items-center gap-2 rounded-lg border border-yellow-500/40 bg-yellow-500/10 text-yellow-200 px-3 py-2 text-sm\">\r\n                        <AlertTriangle size={16} />\r\n                        {summaryError}\r\n                      </div>\r\n                    )}\r\n                    {!summaryLoading && !summaryError && summary.length === 0 && (\r\n                      <div className=\"text-sm text-gray-500\">\r\n                        The summary will include direct citations from the article to preserve attribution.\r\n                        Click{\" \"}\r\n                        <span className=\"text-blue-400\">“Cite-preserving summary”</span> to begin.\r\n                      </div>\r\n                    )}\r\n                    {summary.map((bullet, idx) => (\r\n                      <motion.div\r\n                        key={`${bullet.summary}-${idx}`}\r\n                        initial={{ opacity: 0, y: 6 }}\r\n                        animate={{ opacity: 1, y: 0 }}\r\n                        className=\"rounded-xl border border-gray-700/50 bg-gray-900/50 p-4 shadow-sm\"\r\n                      >\r\n                        <div className=\"flex items-start gap-3 text-gray-100\">\r\n                          <div className=\"flex items-center justify-center h-6 w-6 rounded-full bg-blue-500/20 border border-blue-500/40 text-xs text-blue-200\">\r\n                            {idx + 1}\r\n                          </div>\r\n                          <p className=\"text-sm leading-relaxed\">{bullet.summary}</p>\r\n                        </div>\r\n                        {bullet.citation && (\r\n                          <button\r\n                            onClick={() => handleOpenCitation(bullet.citation?.url)}\r\n                            className=\"mt-3 flex w-full items-start gap-2 rounded-lg bg-gray-900/70 border border-gray-800/70 px-3 py-2 text-xs text-gray-400 hover:text-gray-200 hover:border-gray-700 transition-colors text-left\"\r\n                          >\r\n                            <Quote size={14} className=\"flex-shrink-0 text-gray-500\" />\r\n                            <span className=\"flex-1\">\r\n                              {bullet.citation.text.length > 220\r\n                                ? `${bullet.citation.text.slice(0, 220)}…`\r\n                                : bullet.citation.text}\r\n                            </span>\r\n                            {bullet.citation.url && <ExternalLink size={12} className=\"text-gray-500\" />}\r\n                          </button>\r\n                        )}\r\n                      </motion.div>\r\n                    ))}\r\n                  </div>\r\n                </aside>\r\n              </div>\r\n            )}\r\n          </motion.div>\r\n        </>\r\n      )}\r\n    </AnimatePresence>\r\n  );\r\n}\r\n\r\nfunction sanitizeText(text: string): string {\r\n  return text.replace(/[<>]/g, '').replace(/\\s+/g, ' ');\r\n}\r\n\r\nfunction getHostname(input: string): string {\r\n  try {\r\n    return new URL(input).hostname;\r\n  } catch {\r\n    return input;\r\n  }\r\n}\r\n\r\n"],"file":"ReaderOverlay-BY93HbSi.js"}