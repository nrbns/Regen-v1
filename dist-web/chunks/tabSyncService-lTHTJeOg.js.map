{"version":3,"file":"tabSyncService-lTHTJeOg.js","sources":["../../src/services/sync/tabSyncService.ts"],"sourcesContent":["/**\n * Multi-Tab Sync Service - Future Enhancement #1\n * Yjs + WebSocket for shared state across tabs\n * Syncs: tab order, active tab, tab groups, bookmarks\n */\n\nimport * as Y from 'yjs';\nimport { WebsocketProvider } from 'y-websocket';\nimport { useTabsStore } from '../../state/tabsStore';\n\nexport interface TabSyncState {\n  tabs: Array<{\n    id: string;\n    title: string;\n    url?: string;\n    order: number;\n  }>;\n  activeId: string | null;\n  groups: Array<{\n    id: string;\n    name: string;\n    color: string;\n    tabIds: string[];\n  }>;\n}\n\nclass TabSyncService {\n  private doc: Y.Doc | null = null;\n  private provider: WebsocketProvider | null = null;\n  private tabsArray: Y.Array<Y.Map<any>> | null = null;\n  private activeId: Y.Text | null = null;\n  private groupsArray: Y.Array<Y.Map<any>> | null = null;\n  private isConnected = false;\n  private wsUrl: string;\n\n  constructor(wsUrl: string = 'ws://127.0.0.1:18080/yjs') {\n    this.wsUrl = wsUrl;\n  }\n\n  /**\n   * Initialize Yjs document and WebSocket provider\n   */\n  async initialize(sessionId: string): Promise<void> {\n    if (this.doc) {\n      return; // Already initialized\n    }\n\n    this.doc = new Y.Doc();\n    this.tabsArray = this.doc.getArray('tabs');\n    this.activeId = this.doc.getText('activeId');\n    this.groupsArray = this.doc.getArray('groups');\n\n    // Connect to WebSocket provider\n    this.provider = new WebsocketProvider(this.wsUrl, `session-${sessionId}`, this.doc);\n\n    this.provider.on('status', (event: { status: string }) => {\n      this.isConnected = event.status === 'connected';\n      console.log('[TabSync] Connection status:', event.status);\n    });\n\n    // Observe changes from remote\n    this.tabsArray.observe((_event: Y.YArrayEvent<Y.Map<any>>) => {\n      this.syncFromYjs();\n    });\n\n    this.activeId.observe(() => {\n      const activeId = this.activeId?.toString() || null;\n      const tabsState = useTabsStore.getState();\n      if (activeId && activeId !== tabsState.activeId) {\n        tabsState.setActive(activeId);\n      }\n    });\n\n    this.groupsArray.observe(() => {\n      this.syncFromYjs();\n    });\n\n    // Initial sync from Zustand to Yjs\n    this.syncToYjs();\n\n    // Listen to Zustand changes and sync to Yjs\n    const initialState = useTabsStore.getState();\n    let prevTabs: typeof initialState.tabs = initialState.tabs;\n    let prevActiveId: typeof initialState.activeId = initialState.activeId;\n    let prevTabGroups: typeof initialState.tabGroups = initialState.tabGroups;\n\n    useTabsStore.subscribe(state => {\n      // Only sync if something actually changed\n      if (\n        state.tabs !== prevTabs ||\n        state.activeId !== prevActiveId ||\n        state.tabGroups !== prevTabGroups\n      ) {\n        this.syncToYjs();\n        prevTabs = state.tabs;\n        prevActiveId = state.activeId;\n        prevTabGroups = state.tabGroups;\n      }\n    });\n\n    console.log('[TabSync] Initialized with session:', sessionId);\n  }\n\n  /**\n   * Sync Zustand state to Yjs\n   */\n  private syncToYjs(): void {\n    if (!this.doc || !this.tabsArray || !this.activeId || !this.groupsArray) {\n      console.warn('[TabSync] Cannot sync to Yjs: missing required Yjs structures');\n      return;\n    }\n\n    const tabsState = useTabsStore.getState();\n\n    // Update tabs array - use non-null assertions after null check above\n    const tabsArray = this.tabsArray!;\n    const activeId = this.activeId!;\n    const groupsArray = this.groupsArray!;\n\n    this.doc.transact(() => {\n      // Clear and rebuild tabs array\n      tabsArray.delete(0, tabsArray.length);\n      tabsState.tabs.forEach((tab, index) => {\n        const tabMap = new Y.Map();\n        tabMap.set('id', tab.id);\n        tabMap.set('title', tab.title || '');\n        tabMap.set('url', tab.url || '');\n        tabMap.set('order', index);\n        tabsArray.push([tabMap]);\n      });\n\n      // Update active ID\n      activeId.delete(0, activeId.length);\n      if (tabsState.activeId) {\n        activeId.insert(0, tabsState.activeId);\n      }\n\n      // Update groups\n      groupsArray.delete(0, groupsArray.length);\n      tabsState.tabGroups.forEach(group => {\n        const groupMap = new Y.Map();\n        groupMap.set('id', group.id);\n        groupMap.set('name', group.name);\n        groupMap.set('color', group.color);\n        // Get tab IDs for this group\n        const groupTabIds = tabsState.tabs.filter(t => t.groupId === group.id).map(t => t.id);\n        groupMap.set('tabIds', groupTabIds);\n        groupsArray.push([groupMap]);\n      });\n    });\n  }\n\n  /**\n   * Sync Yjs state to Zustand\n   */\n  private syncFromYjs(): void {\n    if (!this.tabsArray || !this.activeId || !this.groupsArray) {\n      return;\n    }\n\n    const tabsState = useTabsStore.getState();\n\n    // Read tabs from Yjs\n    const yjsTabs = this.tabsArray.toArray().map((tabMap: Y.Map<any>) => ({\n      id: tabMap.get('id'),\n      title: tabMap.get('title') || '',\n      url: tabMap.get('url'),\n      order: tabMap.get('order') || 0,\n    }));\n\n    // Only update if different (avoid loops)\n    const currentTabs = tabsState.tabs;\n    if (\n      yjsTabs.length !== currentTabs.length ||\n      yjsTabs.some((yt, i) => yt.id !== currentTabs[i]?.id || yt.order !== i)\n    ) {\n      // Reorder tabs based on Yjs order\n      const orderedTabs = yjsTabs\n        .sort((a, b) => a.order - b.order)\n        .map(yt => {\n          const existingTab = currentTabs.find(t => t.id === yt.id);\n          return existingTab || { ...yt, id: yt.id, title: yt.title, url: yt.url };\n        });\n\n      tabsState.setAll(orderedTabs);\n    }\n\n    // Update active ID\n    const yjsActiveId = this.activeId.toString() || null;\n    if (yjsActiveId && yjsActiveId !== tabsState.activeId) {\n      tabsState.setActive(yjsActiveId);\n    }\n\n    // Update groups\n    const yjsGroups = this.groupsArray.toArray().map((groupMap: Y.Map<any>) => ({\n      id: groupMap.get('id'),\n      name: groupMap.get('name') || '',\n      color: groupMap.get('color') || '#6366f1',\n      tabIds: groupMap.get('tabIds') || [],\n    }));\n\n    // Sync groups (would need group management in tabsStore)\n    // For now, just log\n    console.log('[TabSync] Groups synced:', yjsGroups);\n  }\n\n  /**\n   * Disconnect and cleanup\n   */\n  disconnect(): void {\n    if (this.provider) {\n      this.provider.destroy();\n      this.provider = null;\n    }\n    if (this.doc) {\n      this.doc.destroy();\n      this.doc = null;\n    }\n    this.isConnected = false;\n    console.log('[TabSync] Disconnected');\n  }\n\n  /**\n   * Get connection status\n   */\n  getStatus(): { connected: boolean; sessionId?: string } {\n    return {\n      connected: this.isConnected,\n    };\n  }\n}\n\n// Singleton instance\nlet tabSyncInstance: TabSyncService | null = null;\n\nexport function getTabSyncService(wsUrl?: string): TabSyncService {\n  if (!tabSyncInstance) {\n    tabSyncInstance = new TabSyncService(wsUrl);\n  }\n  return tabSyncInstance;\n}\n\nexport function initializeTabSync(sessionId: string, wsUrl?: string): Promise<void> {\n  const service = getTabSyncService(wsUrl);\n  return service.initialize(sessionId);\n}\n\nexport function disconnectTabSync(): void {\n  if (tabSyncInstance) {\n    tabSyncInstance.disconnect();\n    tabSyncInstance = null;\n  }\n}\n"],"names":["TabSyncService","wsUrl","__publicField","sessionId","Y.Doc","WebsocketProvider","event","_event","activeId","tabsState","useTabsStore","initialState","prevTabs","prevActiveId","prevTabGroups","state","tabsArray","groupsArray","tab","index","tabMap","Y.Map","group","groupMap","groupTabIds","t","yjsTabs","currentTabs","yt","i","orderedTabs","a","b","yjsActiveId","yjsGroups","tabSyncInstance","getTabSyncService","initializeTabSync"],"mappings":"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"}