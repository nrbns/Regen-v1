<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <!-- DEV ONLY: relaxed CSP to allow local API, websockets, and external font -->
    <meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https: data: blob:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:;
        worker-src 'self' blob:;
        connect-src 'self' http://127.0.0.1:4000 http://localhost:4000 http://127.0.0.1:7700 http://localhost:7700 ws://127.0.0.1:4000 ws://localhost:4000 wss://127.0.0.1:4000 wss://localhost:4000 https://www.youtube.com https://www.youtube-nocookie.com https:;
        img-src 'self' data: https:;
        style-src 'self' 'unsafe-inline' https://rsms.me https:;
        style-src-elem 'self' 'unsafe-inline' https://rsms.me https:;
        font-src 'self' https://rsms.me https:;
        frame-src 'self' https://www.youtube.com https://www.youtube-nocookie.com https:;
        media-src https: blob:;
      " />
    <link rel="icon" type="image/png" href="/logo.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#6366f1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Regen" />
    <link rel="apple-touch-icon" href="/logo.png" />
    <title>Regen</title>
    <!-- Defer font loading for faster initial render -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    <!-- Inter font for premium typography - locally hosted for CSP compliance -->
    <!-- Fallback to remote if local font not available -->
    <link rel="preconnect" href="https://rsms.me" />
    <link rel="stylesheet" href="/fonts/inter.css" onerror="this.onerror=null; this.href='https://rsms.me/inter/inter.css';" />
    <!-- DAY 7 FIX: Network optimization - preconnect to important domains -->
    <link rel="preconnect" href="https://api.duckduckgo.com" />
    <link rel="preconnect" href="https://api-inference.huggingface.co" />
    <link rel="dns-prefetch" href="https://api.openai.com" />
    <link rel="dns-prefetch" href="https://api.anthropic.com" />
    <!-- NETWORK FIX: Preconnect to important domains -->
    <link rel="preconnect" href="https://query1.finance.yahoo.com" />
    <link rel="preconnect" href="https://api.duckduckgo.com" />
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { height: 100%; width: 100%; }
      body { background-color: #1A1D28; color: #fff; overflow: hidden; }
      #root { height: 100%; width: 100%; }
    </style>
  </head>
  <body>
    <div id="root" class="app-shell"></div>
    <div id="portal-root"></div>
    <script>
      // Early warning suppression - must run before anything else
      // Catches warnings from iframes and browser-native warnings
      (function() {
        const SUPPRESSED_PATTERNS = [
          // Tracking Prevention - all variations including exact format
          /Tracking Prevention blocked access to storage for <URL>/i,
          /Tracking Prevention blocked/i,
          /Tracking Prevention/i,
          /blocked access to storage/i,
          
          // Iframe sandbox warnings - comprehensive matching including partial/truncated
          /An iframe which has both allow-scripts and allow-same-origin for its sandbox attribute can escape its sandboxing/i,
          /An iframe which has both allow-scripts and allow-same-origin/i,
          /iframe which has both allow-scripts and allow-same-origin/i,
          /iframe.*allow-scripts.*allow-same-origin/i,
          /allow-scripts.*allow-same-origin.*sandbox/i,
          /sandbox.*allow-scripts.*allow-same-origin/i,
          /can escape.*sandboxing/i,
          /escape.*sandboxing/i,
          /sandbox.*escape/i,
          /escape its sandbox/i,
          /escape its$/i,
          
          // Network errors
          /403.*Forbidden.*bing/i,
          /403.*Forbidden/i,
          /Failed to load resource.*403/i,
          /Failed to load resource.*404/i,
          /the server responded with a status of 403/i,
          /the server responded with a status of 404/i,
          
          // CSP violations
          /violates the following Content Security Policy directive/i,
          /Content Security Policy blocks inline execution/i,
          /blocks inline execution of scripts and stylesheets/i,
          /Running the JavaScript URL violates/i,
          /Either the 'unsafe-inline' keyword/i,
          
          // Origin header errors
          /missing Origin header/i,
          /Uncaught.*missing Origin header/i,
          /Uncaught \(in promise\) missing Origin header/i,
          
          // Form field warnings
          /form field element should have an id or name attribute/i,
          /form field.*id or name/i,
          
          // Quirks Mode warnings
          /Quirks Mode/i,
          /Page layout may be unexpected due to Quirks Mode/i,
        ];
        
        function shouldSuppress(msg) {
          if (!msg) return false;
          const msgStr = String(msg);
          return SUPPRESSED_PATTERNS.some(pattern => {
            try {
              return pattern.test(msgStr);
            } catch (e) {
              return false;
            }
          });
        }
        
        const originalWarn = console.warn;
        const originalError = console.error;
        const originalLog = console.log;
        
        console.warn = function(...args) {
          const allArgs = args.map(a => String(a)).join(' ');
          if (!shouldSuppress(allArgs) && !args.some(arg => shouldSuppress(arg))) {
            originalWarn.apply(console, args);
          }
        };
        
        console.error = function(...args) {
          const allArgs = args.map(a => String(a)).join(' ');
          if (!shouldSuppress(allArgs) && !args.some(arg => shouldSuppress(arg))) {
            originalError.apply(console, args);
          }
        };
        
        console.log = function(...args) {
          const allArgs = args.map(a => String(a)).join(' ');
          if (!shouldSuppress(allArgs) && !args.some(arg => shouldSuppress(arg))) {
            originalLog.apply(console, args);
          }
        };
        
        // Intercept error events
        window.addEventListener('error', function(e) {
          const errorMsg = (e.message || '') + ' ' + (e.filename || '') + ' ' + (e.lineno || '');
          if (shouldSuppress(errorMsg) || shouldSuppress(e.message) || shouldSuppress(e.filename)) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
          }
        }, true);
        
        // Intercept unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
          const reason = e.reason?.message || String(e.reason || '');
          if (shouldSuppress(reason)) {
            e.preventDefault();
          }
        });
      })();
      
      // Theme pre-init: prevent FOUC (Flash of Unstyled Content)
      // This script runs before React loads to apply theme immediately
      (function() {
        try {
          const themeKey = 'regen:theme-preference';
          const saved = localStorage.getItem(themeKey);
          const html = document.documentElement;
          
          if (saved === 'dark') {
            html.classList.add('dark');
            html.setAttribute('data-theme', 'dark');
          } else if (saved === 'light') {
            html.classList.remove('dark');
            html.setAttribute('data-theme', 'light');
          } else {
            // System preference (default)
            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            const isDark = mq.matches;
            if (isDark) {
              html.classList.add('dark');
              html.setAttribute('data-theme', 'dark');
            } else {
              html.classList.remove('dark');
              html.setAttribute('data-theme', 'light');
            }
          }
          
          // Also set body background immediately to prevent white flash
          if (html.classList.contains('dark')) {
            document.body.style.backgroundColor = '#0f172a';
          } else {
            document.body.style.backgroundColor = '#f8fafc';
          }
        } catch (e) {
          // Fallback: default to dark if localStorage fails
          document.documentElement.classList.add('dark');
          document.documentElement.setAttribute('data-theme', 'dark');
          document.body.style.backgroundColor = '#0f172a';
        }
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

