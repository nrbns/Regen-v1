#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”’ Running pre-commit quality gates..."
echo "âŒ Cannot bypass with --no-verify in CI/production"
echo ""

# Check if we're in a CI environment or on protected branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
IS_CI=${CI:-false}

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ] || [ "$IS_CI" = "true" ]; then
  echo "âš ï¸  On protected branch '$BRANCH' - all checks enforced"
fi

# Run lint-staged (format + lint)
echo "ğŸ“ Running linters and formatters..."
npx lint-staged

# Run type check
echo "ğŸ” Type checking..."
npm run typecheck || {
  echo "âŒ Type check failed"
  exit 1
}

# Run unit tests on staged files
echo "ğŸ§ª Running unit tests..."
npm run test:unit -- --run || {
  echo "âŒ Unit tests failed"
  exit 1
}

echo "âœ… All pre-commit checks passed"
